<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K√©zilabda stat ‚Äì V5 (teljes, ment√©ssel √©s exporttal)</title>
<meta name="theme-color" content="#1b5cff">

<!-- Export k√∂nyvt√°rak -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0b0c0f; --panel:#0f1218; --card:#101522; --muted:#94a3b8; --text:#e6edf6;
    --accent:#1b5cff; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444; --border:#1f283a; --chip:#0f1a2a;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:11px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  .topbar{position:sticky;top:0;z-index:100;background:var(--panel);border-bottom:1px solid var(--border)}
  .wrap{max-width:1200px;margin:0 auto;padding:6px 8px;display:flex;gap:6px;flex-wrap:wrap;align-items:center}
  .brand{font-weight:800;letter-spacing:.2px}
  .pill{display:flex;gap:6px;align-items:center;padding:3px 6px;border:1px solid var(--border);background:var(--chip);border-radius:6px}
  .pill input,.pill select{border:0;background:transparent;outline:none;color:var(--text);font-size:11px}
  .btn{border:1px solid var(--border);background:var(--card);color:var(--text);border-radius:6px;padding:3px 6px;cursor:pointer;font-size:11px;display:inline-flex;align-items:center;gap:4px}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ok{background:var(--ok);color:#fff}
  .btn.warn{background:var(--warn);color:#000}
  .btn.dan{background:var(--danger);color:#fff}
  .timer{font-variant-numeric:tabular-nums;font-size:14px;font-weight:800;padding:2px 6px;border-radius:6px;border:1px solid var(--border);background:var(--card)}
  .container{max-width:1200px;margin:10px auto;padding:0 8px;display:grid;gap:8px}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:980px){.grid{grid-template-columns:1fr 1fr}}
  .card{border:1px solid var(--border);border-radius:8px;background:var(--card)}
  .inner{padding:8px}
  .teamhdr{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}
  .teamleft{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px}
  table{width:100%;border-collapse:collapse;font-size:10.5px;table-layout:fixed}
  thead th{position:sticky;top:0;background:var(--panel);border-bottom:1px solid var(--border);padding:2px 4px;text-align:center;font-weight:800;z-index:1}
  tbody td{border-bottom:1px solid var(--border);padding:2px 3px;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  td.left,th.left{text-align:left}
  .sticky-col{position:sticky;left:0;background:var(--card);z-index:2}
  .sticky-col::after{content:"";position:absolute;right:-1px;top:0;bottom:0;width:1px;background:var(--border)}
  .namecell{display:flex;gap:3px;align-items:center}
  .num{width:2.6rem;text-align:center;padding:2px 3px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:10.5px}
  .name{flex:1;min-width:100px;padding:2px 4px;border:1px solid var(--border);border-radius:4px;background:var(--panel);color:var(--text);font-size:10.5px}
  .enroll{width:1.1rem;height:1.1rem}
  .inactive{opacity:.55}
  .onbtn{cursor:pointer;padding:2px 6px;border-radius:6px;border:1px solid var(--border);font-weight:800}
  .onbtn.on{background:#16a34a;color:#fff}
  .onbtn.off{background:#6b7280;color:#fff}
  .twoPtoggle{margin-left:4px;padding:0 6px;border-radius:10px;border:1px solid var(--border);background:#2a1a1a;color:#fff;cursor:pointer}
  .twoPtoggle.active{background:#ef4444}
  .susp-badge{display:inline-block;margin-left:6px;padding:0 6px;border-radius:999px;background:#ef4444;color:#fff;font-weight:800}
  .hint{color:var(--muted);font-size:10px}
  tr.selected{outline:2px solid var(--accent);outline-offset:-2px}
  .left.sticky-col{cursor:pointer}
  .time-edit{display:none;gap:6px;align-items:center}
  .time-edit.on{display:flex}
  .time-edit input{width:64px;text-align:center;border:1px solid var(--border);border-radius:6px;background:var(--panel);color:var(--text);padding:2px 4px}
  .veszprem-bar{display:flex;gap:6px;align-items:center;margin:6px 8px 0}
  /* Panelok */
  #savedPanel,#helpModal{display:none;position:fixed;inset:10% 15%;background:#0f1218;border:1px solid #1f283a;border-radius:8px;z-index:1000;padding:10px;overflow:auto}
</style>
</head>
<body>

<div class="topbar">
  <div class="wrap">
    <div class="brand">K√©zilabda stat ‚Äì V5</div>

    <span class="pill">M√©rk≈ëz√©s: <input id="matchName" placeholder="Pl. Veszpr√©m‚ÄìSzeged"></span>
    <span class="pill">D√°tum: <input id="matchDate" type="date"></span>

    <span class="pill">F√©lid≈ë: <span id="halfLabel">1.</span></span>
    <span class="timer" id="clock">00:00</span>

    <button class="btn primary" id="startBtn">‚ñ∂Ô∏é Start</button>
    <button class="btn" id="pauseBtn">‚è∏Ô∏é Pause</button>
    <button class="btn warn" id="switchHalfBtn">F√©lid≈ë v√°lt√°s</button>

    <span class="pill">TOC m√≥d:
      <select id="tocModeSel">
        <option value="simple" selected>Egyszer≈±</option>
        <option value="detailed">R√©szletes</option>
      </select>
    </span>

    <span class="pill">
      <label><input type="checkbox" id="timeEditToggle"> Id≈ë szerkeszt≈ë</label>
    </span>
    <div id="timeEditPanel" class="time-edit">
      <span class="pill">√öj id≈ë: <input type="text" id="timeInput" value="00:00" title="MM:SS"></span>
      <button class="btn" id="tMinus30">-30</button>
      <button class="btn" id="tMinus10">-10</button>
      <button class="btn" id="tPlus10">+10</button>
      <button class="btn" id="tPlus30">+30</button>
      <button class="btn ok" id="tApply">Be√°ll√≠t</button>
    </div>

    <button class="btn" id="undoBtn"><span>‚Ü©</span><span id="undoLabel"> Visszavon√°s</span></button>
    <button class="btn" id="saveLocalBtn">üíæ Ment√©s</button>
    <button class="btn" id="openLocalBtn">üìÇ Megnyit√°s</button>
    <button class="btn" id="exportJsonBtn">JSON</button>
    <label class="btn">‚¨Ü JSON<input type="file" id="importJsonInput" accept="application/json" style="display:none"></label>
    <button class="btn" id="exportXlsxBtn">XLSX</button>
    <button class="btn" id="exportPdfBtn">PDF</button>
    <button class="btn" id="helpBtn">‚ùì S√∫g√≥</button>
  </div>
</div>

<div class="container">
  <div class="grid">
    <!-- CSAPAT A -->
    <div class="card">
      <div class="inner teamhdr">
        <div class="teamleft">
          <span class="pill">J√°t√©kos (A): <select id="pickerA"></select></span>
          <button class="btn ok" id="thA">TH +</button>
          <button class="btn" id="blA">BL +</button>
          <button class="btn warn" id="s2a">2P KEZD</button>
          <button class="btn" id="e2a">2P V√âGE</button>
        </div>
        <div class="teamright">
          <button class="btn" id="allOnA">√ñsszes be</button>
          <button class="btn" id="allOffA">√ñsszes ki</button>
          <button class="btn" id="pasteA">Gyors keret</button>
        </div>
      </div>

      <div class="veszprem-bar">
        <label class="pill"><input type="checkbox" id="vzA"> ONE Veszpr√©m keret</label>
        <button class="btn" id="vzLoadA">Beolvas</button>
        <span class="hint">Beolvas√°s ut√°n szerkeszthet≈ë √©s b≈ëv√≠thet≈ë.</span>
      </div>

      <div class="inner table-wrap">
        <table>
          <thead>
            <tr>
              <th class="left sticky-col" style="width:240px">‚úì # / N√©v (A)</th>
              <th style="width:90px">ON / 2P</th>
              <th style="width:70px">MIN</th>
              <th style="width:52px">L√∂v</th>
              <th style="width:52px">G√≥l</th>
              <th style="width:44px">%</th>
              <th style="width:44px">7A</th>
              <th style="width:44px">7G</th>
              <th style="width:44px">7%</th>
              <th style="width:52px">TH</th>
              <th style="width:52px">BL</th>
            </tr>
          </thead>
          <tbody id="bodyA"></tbody>
        </table>
      </div>

      <!-- Gyors keret panel ‚Äì A -->
      <div id="rosterPanelA" class="inner" style="display:none">
        <div class="pill">Gyors keret beilleszt√©se (A):</div>
        <textarea id="rosterTextA" style="width:100%;min-height:120px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px"
          placeholder="#23 LIGETV√ÅRI PATRIK&#10;#29 NEDIM REMILI&#10;#24 GASPER MARGUC"></textarea>
        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
          <button class="btn" id="rosterCancelA">M√©gse</button>
          <button class="btn ok" id="rosterApplyA">Beolvas</button>
        </div>
      </div>

      <div class="inner hint">Egyszer≈±: pipa = p√°ly√°n. R√©szletes: ON gomb. 2P alatt a MIN nem ketyeg. A n√©vre kattintva kijel√∂l√∂d a sort (2P a kijel√∂ltre megy). ON mellett kis ‚Äûx‚Äù = 2P gyors kapcsol√≥.</div>
    </div>

    <!-- CSAPAT B -->
    <div class="card">
      <div class="inner teamhdr">
        <div class="teamleft">
          <span class="pill">J√°t√©kos (B): <select id="pickerB"></select></span>
          <button class="btn ok" id="thB">TH +</button>
          <button class="btn" id="blB">BL +</button>
          <button class="btn warn" id="s2b">2P KEZD</button>
          <button class="btn" id="e2b">2P V√âGE</button>
        </div>
        <div class="teamright">
          <button class="btn" id="allOnB">√ñsszes be</button>
          <button class="btn" id="allOffB">√ñsszes ki</button>
          <button class="btn" id="pasteB">Gyors keret</button>
        </div>
      </div>

      <div class="veszprem-bar">
        <label class="pill"><input type="checkbox" id="vzB"> ONE Veszpr√©m keret</label>
        <button class="btn" id="vzLoadB">Beolvas</button>
        <span class="hint">Beolvas√°s ut√°n szerkeszthet≈ë √©s b≈ëv√≠thet≈ë.</span>
      </div>

      <div class="inner table-wrap">
        <table>
          <thead>
            <tr>
              <th class="left sticky-col" style="width:240px">‚úì # / N√©v (B)</th>
              <th style="width:90px">ON / 2P</th>
              <th style="width:70px">MIN</th>
              <th style="width:52px">L√∂v</th>
              <th style="width:52px">G√≥l</th>
              <th style="width:44px">%</th>
              <th style="width:44px">7A</th>
              <th style="width:44px">7G</th>
              <th style="width:44px">7%</th>
              <th style="width:52px">TH</th>
              <th style="width:52px">BL</th>
            </tr>
          </thead>
          <tbody id="bodyB"></tbody>
        </table>
      </div>

      <!-- Gyors keret panel ‚Äì B -->
      <div id="rosterPanelB" class="inner" style="display:none">
        <div class="pill">Gyors keret beilleszt√©se (B):</div>
        <textarea id="rosterTextB" style="width:100%;min-height:120px;background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:6px;padding:6px"
          placeholder="#10 MINTA J√ÅT√âKOS&#10;#7 VALAKI&#10;#22 M√ÅSVALAKI"></textarea>
        <div style="display:flex;gap:6px;justify-content:flex-end;margin-top:6px">
          <button class="btn" id="rosterCancelB">M√©gse</button>
          <button class="btn ok" id="rosterApplyB">Beolvas</button>
        </div>
      </div>

      <div class="inner hint">Egyszer≈±: pipa = p√°ly√°n. R√©szletes: ON gomb. 2P alatt a MIN nem ketyeg. A n√©vre kattintva kijel√∂l√©s m≈±k√∂dik. ON mellett kis ‚Äûx‚Äù = 2P.</div>
    </div>
  </div>
</div>

<!-- Mentett meccsek panel -->
<div id="savedPanel">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:bold">Mentett m√©rk≈ëz√©sek</div>
    <button class="btn" id="savedCloseBtn">Bez√°r</button>
  </div>
  <div class="hint" style="margin:6px 0 4px">Keres√©s: d√°tum / csapat / j√°t√©kos</div>
  <input id="savedSearch" placeholder="pl. 2025-09, Veszpr√©m, Patrik" style="width:100%;margin:0 0 8px;padding:6px;border:1px solid var(--border);border-radius:6px;background:var(--card);color:var(--text)">
  <table style="width:100%;border-collapse:collapse">
    <thead>
      <tr>
        <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">D√°tum</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">M√©rk≈ëz√©s</th>
        <th style="text-align:left;padding:6px;border-bottom:1px solid var(--border)">Mentve ekkor</th>
        <th style="padding:6px;border-bottom:1px solid var(--border)">M≈±velet</th>
      </tr>
    </thead>
    <tbody id="savedBody"></tbody>
  </table>
</div>

<!-- S√∫g√≥ panel -->
<div id="helpModal">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:bold">Haszn√°lati jegyzet</div>
    <button class="btn" id="helpCloseBtn">Bez√°r</button>
  </div>
  <div style="margin-top:10px;line-height:1.5">
    üíæ <b>Ment√©s</b> ‚Üí a b√∂ng√©sz≈ë helyi t√°rj√°ba ment (nem szerverre). Kulcs: <i>D√°tum___Meccsn√©v</i>.<br>
    üìÇ <b>Megnyit√°s</b> ‚Üí felugr√≥ panel list√°val; <b>Megnyit</b> / <b>T√∂r√∂l</b> gombokkal.<br>
    <b>JSON</b> ‚Üí f√°jlba export (offline biztons√°gi ment√©s).<br>
    ‚¨Ü <b>JSON</b> ‚Üí kor√°bbi JSON visszat√∂lt√©se.<br>
    <b>XLSX / PDF</b> ‚Üí t√°bl√°zatos export mindk√©t csapatra (k√ºl√∂n lap, ill. k√©t t√°bla).
  </div>
</div>

<script>
/* ===== Seg√©dek ===== */
const $=id=>document.getElementById(id);
const pct=(n,d)=> d? (Math.round((n/d*1000))/10).toFixed(1)+"%":"0%";
const toMMSS=(sec)=>{sec=Math.max(0,Math.floor(sec));const m=Math.floor(sec/60),s=sec%60;return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');};
const todayStr=()=> new Date().toISOString().slice(0,10);

/* ===== √Ållapot ===== */
const MAXP=25, UNDO_LIMIT=40;
const emptyPlayer=()=>({active:true,num:"",name:"",shots:0,goals:0,p7a:0,p7g:0,th:0,bl:0,on:false,tocSec:0,susp:false});
const emptyTeam =()=>({players:Array.from({length:MAXP}, emptyPlayer)});
let state={ matchName:"", matchDate:todayStr(), half:1, elapsed:0, tocMode:'simple', A:emptyTeam(), B:emptyTeam() };
let tmr=null, undoStack=[];
let selectedRow={A:null,B:null};

/* ===== ONE Veszpr√©m keret ===== */
const ONE_VESZPREM=[
  {num:"1",  name:"MIKAEL APPELGREN"},
  {num:"2",  name:"THIAGUS PETRUS"},
  {num:"5",  name:"IVAN MARTINOVIC"},
  {num:"9",  name:"HUGO DESCAT"},
  {num:"12", name:"RODRIGO CORRALES"},
  {num:"15", name:"AHMED HESHAM"},
  {num:"21", name:"BJARKI M√ÅR EL√çSSON"},
  {num:"23", name:"LIGETV√ÅRI PATRIK"},
  {num:"24", name:"GASPER MARGUC"},
  {num:"25", name:"LUKA CINDRIC"},
  {num:"27", name:"DOPJERA ADAM"},
  {num:"29", name:"NEDIM REMILI"},
  {num:"32", name:"YANIS LENNE"},
  {num:"39", name:"YEHIA ELDERAA"},
  {num:"46", name:"DRAGAN PECHMALBEC"},
  {num:"54", name:"BALOGH BOTOND"},
  {num:"66", name:"G√ÅNCS-PET≈ê M√ÅT√â"},
  {num:"67", name:"GY≈êRI N√ÅNDOR"},
  {num:"77", name:"KARDOS M√ÅRTON CSABA"},
  {num:"80", name:"AHMED ADEL"},
  {num:"88", name:"MOLN√ÅR ROBIN"},
  {num:"90", name:"ALI ZEIN"},
  {num:"91", name:"V√ÅRADY-SZAB√ì L√ÅSZL√ì"},
  {num:"97", name:"SZAB√ì LEVENTE"},
  {num:"98", name:"BARNA J√ÅNOS D√ÅNIEL"},
];

/* ===== Undo ===== */
function updateUndoLabel(){ const u=undoStack[0]; $('undoLabel').textContent=u?(' '+u.label):' Visszavon√°s'; $('undoBtn').disabled=!u; }
function pushUndoTime(label, prevAbs){ undoStack.unshift({type:'time',label,prevAbs}); if(undoStack.length>UNDO_LIMIT) undoStack.pop(); updateUndoLabel(); }
function pushUndoToggle(label, side, index, field, prev){ undoStack.unshift({type:'toggle',label,side,index,field,prev}); if(undoStack.length>UNDO_LIMIT) undoStack.pop(); updateUndoLabel(); }
function pushUndoDelta(label, side, index, field, delta){ undoStack.unshift({type:'delta',label,side,index,field,delta}); if(undoStack.length>UNDO_LIMIT) undoStack.pop(); updateUndoLabel(); }

$('undoBtn').onclick=()=>{
  const u=undoStack.shift(); if(!u) return;
  if(u.type==='time'){
    const abs=u.prevAbs;
    state.half = abs<30*60?1:2;
    state.elapsed = abs - (state.half===1?0:30*60);
    displayTime();
  }else if(u.type==='toggle'){
    const p=state[u.side].players[u.index]; if(!p) return;
    p[u.field]=u.prev; renderTeam(u.side); updateUndoLabel();
  }else if(u.type==='delta'){
    const p=state[u.side].players[u.index]; if(!p) return;
    if(u.field==='_goal'){ p.goals=Math.max(0,p.goals+u.delta); p.shots=Math.max(0,p.shots+u.delta); }
    else if(u.field==='_7a'){ p.p7a=Math.max(0,p.p7a+u.delta); p.shots=Math.max(0,p.shots+u.delta); }
    else if(u.field==='_7g'){ p.p7g=Math.max(0,p.p7g+u.delta); p.p7a=Math.max(0,p.p7a+u.delta); p.shots=Math.max(0,p.shots+u.delta); p.goals=Math.max(0,p.goals+u.delta); }
    else { p[u.field]=Math.max(0,(p[u.field]||0)+u.delta); }
    renderTeam(u.side); updateUndoLabel();
  }
};

/* ===== √ìra √©s f√©lid≈ëk ===== */
function displayTime(){
  const base=(state.half===1?0:30*60);
  $('clock').textContent=toMMSS(base+state.elapsed);
  $('halfLabel').textContent=state.half+'.';
  $('timeInput').value=toMMSS(base+state.elapsed);
}
function start(){ if(tmr) return; tmr=setInterval(()=>{
  // f√©lid≈ënk√©nt 30 perc saj√°t sz√°ml√°l√≥ban
  if(state.elapsed < 30*60) state.elapsed++;
  // p√°ly√°n t√∂lt√∂tt id≈ë ketyegtet√©se
  ['A','B'].forEach(s=> state[s].players.forEach(p=>{
    const on = (state.tocMode==='simple') ? p.active : p.on;
    if(on && !p.susp) p.tocSec++;
  }));
  displayTime(); renderTeam('A'); renderTeam('B');
},1000); }
function pause(){ if(!tmr) return; clearInterval(tmr); tmr=null; }
function switchHalf(){ pause(); state.half = (state.half===1?2:1); state.elapsed=0; displayTime(); }

$('startBtn').onclick=start;
$('pauseBtn').onclick=pause;
$('switchHalfBtn').onclick=switchHalf;

$('timeEditToggle').onchange=e=>{ $('timeEditPanel').classList.toggle('on', e.target.checked); };
function absTime(){ return (state.half===1?0:30*60)+state.elapsed; }
$('tMinus30').onclick=()=>{ if(!$('timeEditToggle').checked) return; const prev=absTime(); const v=Math.max(0, prev-30); state.half=v<1800?1:2; state.elapsed=v-(state.half===1?0:1800); pushUndoTime('Id≈ë -30s', prev); displayTime(); };
$('tMinus10').onclick=()=>{ if(!$('timeEditToggle').checked) return; const prev=absTime(); const v=Math.max(0, prev-10); state.half=v<1800?1:2; state.elapsed=v-(state.half===1?0:1800); pushUndoTime('Id≈ë -10s', prev); displayTime(); };
$('tPlus10').onclick=()=>{ if(!$('timeEditToggle').checked) return; const prev=absTime(); const v=prev+10; state.half=v<1800?1:2; state.elapsed=v-(state.half===1?0:1800); pushUndoTime('Id≈ë +10s', prev); displayTime(); };
$('tPlus30').onclick=()=>{ if(!$('timeEditToggle').checked) return; const prev=absTime(); const v=prev+30; state.half=v<1800?1:2; state.elapsed=v-(state.half===1?0:1800); pushUndoTime('Id≈ë +30s', prev); displayTime(); };
$('tApply').onclick=()=>{ if(!$('timeEditToggle').checked) return;
  const m=$('timeInput').value.match(/^(\d{1,2}):([0-5]\d)$/); if(!m) return alert('Form√°tum: MM:SS');
  const prev=absTime(); const abs=parseInt(m[1])*60+parseInt(m[2]); state.half=abs<1800?1:2; state.elapsed=abs-(state.half===1?0:1800);
  pushUndoTime('Id≈ë be√°ll√≠tva', prev); displayTime();
};

/* ===== Render ===== */
function populatePicker(side){
  const pick=(side==='A')?$('pickerA'):$('pickerB'); const sel=pick.value;
  pick.innerHTML="";
  state[side].players.forEach((p,i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${p.num||i+1} ‚Äì ${p.name||('J√°t√©kos '+(i+1))}`; pick.appendChild(o); });
  if(sel) pick.value=sel;
}
function renderTeam(side){
  const body=document.querySelector(side==='A'?'#bodyA':'#bodyB'); body.innerHTML="";
  const team=state[side];
  team.players.forEach((p,i)=>{
    const tr=document.createElement('tr'); if(!p.active) tr.classList.add('inactive'); if(selectedRow[side]===i) tr.classList.add('selected');

    const td=document.createElement('td'); td.className='left sticky-col';
    const wrap=document.createElement('div'); wrap.className='namecell';
    const chk=document.createElement('input'); chk.type='checkbox'; chk.className='enroll'; chk.checked=p.active;
    chk.addEventListener('change',()=>{ pushUndoToggle('Nevez√©s',side,i,'active',p.active); p.active=chk.checked; renderTeam(side); });
    const num=document.createElement('input'); num.className='num'; num.placeholder='#'; num.value=p.num; num.addEventListener('input',()=>{ p.num=num.value; populatePicker(side); });
    const name=document.createElement('input'); name.className='name'; name.placeholder='N√©v'; name.value=p.name; name.addEventListener('input',()=>{ p.name=name.value; populatePicker(side); });
    wrap.append(chk,num,name); td.append(wrap);
    td.addEventListener('click',ev=>{ if(ev.target.tagName==='INPUT') return; selectedRow[side]=(selectedRow[side]===i?null:i); populatePicker(side); renderTeam(side); });
    tr.append(td);

    const tdOn=document.createElement('td');
    const onb=document.createElement('button'); onb.className='onbtn '+(p.on?'on':'off'); onb.textContent=p.on?'ON':'OFF';
    onb.disabled=(state.tocMode!=='detailed'); onb.style.opacity=(state.tocMode==='detailed')?'1':'.55';
    onb.addEventListener('click',()=>{ pushUndoToggle('ON/OFF',side,i,'on',p.on); p.on=!p.on; renderTeam(side); });
    const two=document.createElement('button'); two.className='twoPtoggle'+(p.susp?' active':''); two.textContent='x'; two.title='2 perc gyors kapcsol√≥';
    two.addEventListener('click',()=>{ pushUndoToggle('2P',side,i,'susp',p.susp); p.susp=!p.susp; renderTeam(side); });
    tdOn.append(onb,two); tr.append(tdOn);

    const tdMin=document.createElement('td'); tdMin.textContent=toMMSS(p.tocSec||0); if(p.susp){ const b=document.createElement('span'); b.className='susp-badge'; b.textContent='2P'; tdMin.appendChild(b); } tr.append(tdMin);

    const mk=(val,fn)=>{ const td=document.createElement('td'); td.textContent=val; td.style.cursor='pointer'; td.addEventListener('click',()=>{ fn(); renderTeam(side); }); return td; };
    tr.appendChild(mk(p.shots,()=>{ p.shots++; pushUndoDelta('L√∂v√©s',side,i,'shots',-1); }));
    tr.appendChild(mk(p.goals,()=>{ p.goals++; p.shots++; pushUndoDelta('G√≥l',side,i,'_goal',-1); }));
    const tdPct=document.createElement('td'); tdPct.textContent=pct(p.goals,p.shots); tr.appendChild(tdPct);
    tr.appendChild(mk(p.p7a ,()=>{ p.p7a++; p.shots++; pushUndoDelta('7A',side,i,'_7a',-1); }));
    tr.appendChild(mk(p.p7g ,()=>{ p.p7g++; p.p7a++; p.shots++; p.goals++; pushUndoDelta('7G',side,i,'_7g',-1); }));
    const td7p=document.createElement('td'); td7p.textContent=pct(p.p7g,p.p7a); tr.appendChild(td7p);
    tr.appendChild(mk(p.th   ,()=>{ p.th++; pushUndoDelta('TH',side,i,'th',-1); }));
    tr.appendChild(mk(p.bl   ,()=>{ p.bl++; pushUndoDelta('BL',side,i,'bl',-1); }));

    body.appendChild(tr);
  });
  populatePicker(side);
}
function renderAll(){ $('matchName').value=state.matchName; $('matchDate').value=state.matchDate; $('halfLabel').textContent=state.half+"."; $('tocModeSel').value=state.tocMode; displayTime(); renderTeam('A'); renderTeam('B'); updateUndoLabel(); }

/* ===== TOC m√≥d kapcsol√≥ ===== */
$('tocModeSel').onchange=e=>{ state.tocMode=e.target.value; renderTeam('A'); renderTeam('B'); };

/* ===== 2P gombok ===== */
function getTargetIndex(side){ return selectedRow[side]!==null?selectedRow[side]:parseInt((side==='A'?$('pickerA'):$('pickerB')).value||0); }
$('s2a').onclick=()=>{ const i=getTargetIndex('A'); const p=state.A.players[i]; pushUndoToggle('2P kezd', 'A', i, 'susp', p.susp); p.susp=true; renderTeam('A'); };
$('e2a').onclick=()=>{ const i=getTargetIndex('A'); const p=state.A.players[i]; pushUndoToggle('2P v√©ge', 'A', i, 'susp', p.susp); p.susp=false; renderTeam('A'); };
$('s2b').onclick=()=>{ const i=getTargetIndex('B'); const p=state.B.players[i]; pushUndoToggle('2P kezd', 'B', i, 'susp', p.susp); p.susp=true; renderTeam('B'); };
$('e2b').onclick=()=>{ const i=getTargetIndex('B'); const p=state.B.players[i]; pushUndoToggle('2P v√©ge', 'B', i, 'susp', p.susp); p.susp=false; renderTeam('B'); };

/* ===== Gyors keret ===== */
function applyRosterText(side,text){
  const lines=text.split(/\n/).map(s=>s.trim()).filter(Boolean).slice(0,MAXP);
  lines.forEach((ln,i)=>{
    const m=ln.match(/^#?\s*(\d+)\s*[‚Äì-]?\s+(.*)$/);
    if(m){ state[side].players[i].num=m[1]; state[side].players[i].name=m[2]; }
    else { state[side].players[i].name=ln.replace(/^#\s*/,''); state[side].players[i].num=String(i+1); }
    state[side].players[i].active=true;
  });
  renderTeam(side);
}
$('pasteA').onclick=()=>{ $('rosterPanelA').style.display=$('rosterPanelA').style.display==='block'?'none':'block'; };
$('pasteB').onclick=()=>{ $('rosterPanelB').style.display=$('rosterPanelB').style.display==='block'?'none':'block'; };
$('rosterCancelA').onclick=()=>{ $('rosterPanelA').style.display='none'; };
$('rosterCancelB').onclick=()=>{ $('rosterPanelB').style.display='none'; };
$('rosterApplyA').onclick=()=>{ applyRosterText('A',$('rosterTextA').value); $('rosterPanelA').style.display='none'; };
$('rosterApplyB').onclick=()=>{ applyRosterText('B',$('rosterTextB').value); $('rosterPanelB').style.display='none'; };

/* ===== ONE Veszpr√©m beolvas√°sa ===== */
function loadVeszpremInto(side){
  ONE_VESZPREM.slice(0,MAXP).forEach((pl,i)=>{ state[side].players[i].num=pl.num; state[side].players[i].name=pl.name; state[side].players[i].active=true; });
  renderTeam(side);
}
$('vzLoadA').onclick=()=>{ if($('vzA').checked) loadVeszpremInto('A'); else alert('Pip√°ld be: ONE Veszpr√©m keret'); };
$('vzLoadB').onclick=()=>{ if($('vzB').checked) loadVeszpremInto('B'); else alert('Pip√°ld be: ONE Veszpr√©m keret'); };

/* ===== √ñsszes be/ki ===== */
$('allOnA').onclick=()=>{ state.A.players.forEach(p=>{ p.active=true; if(state.tocMode==='detailed') p.on=true; }); renderTeam('A'); };
$('allOffA').onclick=()=>{ state.A.players.forEach(p=>{ p.active=false; if(state.tocMode==='detailed') p.on=false; }); renderTeam('A'); };
$('allOnB').onclick=()=>{ state.B.players.forEach(p=>{ p.active=true; if(state.tocMode==='detailed') p.on=true; }); renderTeam('B'); };
$('allOffB').onclick=()=>{ state.B.players.forEach(p=>{ p.active=false; if(state.tocMode==='detailed') p.on=false; }); renderTeam('B'); };

/* ===== Stat gyorsgombok (TH/BL a picker alapj√°n) ===== */
$('thA').onclick=()=>{ const i=parseInt($('pickerA').value||0,10); state.A.players[i].th++; pushUndoDelta('TH', 'A', i, 'th', -1); renderTeam('A'); };
$('blA').onclick=()=>{ const i=parseInt($('pickerA').value||0,10); state.A.players[i].bl++; pushUndoDelta('BL', 'A', i, 'bl', -1); renderTeam('A'); };
$('thB').onclick=()=>{ const i=parseInt($('pickerB').value||0,10); state.B.players[i].th++; pushUndoDelta('TH', 'B', i, 'th', -1); renderTeam('B'); };
$('blB').onclick=()=>{ const i=parseInt($('pickerB').value||0,10); state.B.players[i].bl++; pushUndoDelta('BL', 'B', i, 'bl', -1); renderTeam('B'); };

/* ===== Ment√©s / vissza√°ll√≠t√°s / export ===== */
const STORAGE_KEY_PREFIX="kezistats_v5_";
function snapshot(){ return JSON.parse(JSON.stringify(state)); }
function applySnapshot(snap){
  if(!snap) return;
  pause();
  // konzervat√≠v vissza√°ll√≠t√°s
  state = Object.assign({A:emptyTeam(),B:emptyTeam(),half:1,elapsed:0,tocMode:'simple'}, snap);
  selectedRow={A:null,B:null};
  renderAll();
}
function makeStorageKey(){
  const d=(state.matchDate||'').trim() || todayStr();
  const m=(state.matchName||'meccs').trim().replace(/[^\w\d\- ]+/g,'_').slice(0,50);
  return STORAGE_KEY_PREFIX + d + "___" + m;
}
function saveToLocal(){
  const key=makeStorageKey();
  localStorage.setItem(key, JSON.stringify({savedAt:Date.now(), data:snapshot()}));
  alert("Elmentve: "+key.replace(STORAGE_KEY_PREFIX,''));
}
function loadAllKeys(){
  const keys=[]; for(let i=0;i<localStorage.length;i++){ const k=localStorage.key(i); if(k&&k.startsWith(STORAGE_KEY_PREFIX)) keys.push(k); }
  keys.sort((a,b)=>{ const A=JSON.parse(localStorage.getItem(a)||'{}')?.savedAt||0; const B=JSON.parse(localStorage.getItem(b)||'{}')?.savedAt||0; return B-A; });
  return keys;
}
function openSavedPanel(){
  const body=$('savedBody'); body.innerHTML="";
  loadAllKeys().forEach(k=>{
    const rec=JSON.parse(localStorage.getItem(k)||'{}');
    const when=new Date(rec.savedAt||Date.now()).toLocaleString();
    const [d,m]=k.replace(STORAGE_KEY_PREFIX,'').split('___');
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="padding:6px;border-bottom:1px solid var(--border)">${d||''}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">${m||''}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border);color:var(--muted)">${when}</td>
      <td style="padding:6px;border-bottom:1px solid var(--border)">
        <button class="btn" data-open="${k}">Megnyit</button>
        <button class="btn dan" data-del="${k}">T√∂r√∂l</button>
      </td>`;
    body.appendChild(tr);
  });
  $('savedPanel').style.display='block';
  $('savedSearch').value='';
  document.querySelectorAll('[data-open]').forEach(b=>{
    b.onclick=()=>{ const k=b.getAttribute('data-open'); const rec=JSON.parse(localStorage.getItem(k)||'{}'); applySnapshot(rec.data); $('savedPanel').style.display='none'; };
  });
  document.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=()=>{ const k=b.getAttribute('data-del'); if(confirm('Biztosan t√∂rl√∂d?')){ localStorage.removeItem(k); openSavedPanel(); } };
  });
}
$('savedCloseBtn').onclick=()=>{ $('savedPanel').style.display='none'; };
$('savedSearch').addEventListener('input',e=>{
  const q=e.target.value.toLowerCase();
  document.querySelectorAll('#savedBody tr').forEach(r=>{ r.style.display= r.innerText.toLowerCase().includes(q)?'':'none'; });
});

$('saveLocalBtn').onclick=saveToLocal;
$('openLocalBtn').onclick=openSavedPanel;

/* JSON export / import */
$('exportJsonBtn').onclick=()=>{
  const a=document.createElement('a');
  const d=(state.matchDate||todayStr());
  const m=(state.matchName||'meccs').replace(/[^\w\d\- ]+/g,'_').slice(0,50);
  a.href="data:application/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(snapshot(),null,2));
  a.download=`kezistats_${d}_${m}.json`; a.click();
};
$('importJsonInput').onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{ try{ applySnapshot(JSON.parse(ev.target.result)); }catch{ alert('√ârv√©nytelen JSON'); } }; r.readAsText(f); };

/* XLSX export */
function exportXLSX(){
  if(typeof XLSX==='undefined') return alert('XLSX k√∂nyvt√°r nem el√©rhet≈ë.');
  const teamSheet=side=> XLSX.utils.json_to_sheet(state[side].players.map((p,i)=>({
    Sorsz√°m:i+1, Nevezett:p.active?1:0, Mez:p.num||'', N√©v:p.name||'',
    ON:p.on?1:0, MIN:toMMSS(p.tocSec||0),
    L√∂v√©s:p.shots||0, G√≥l:p.goals||0, "%":(p.shots?Math.round(p.goals/p.shots*100):0)+"%",
    "7A":p.p7a||0, "7G":p.p7g||0, "7%":(p.p7a?Math.round(p.p7g/p.p7a*100):0)+"%",
    TH:p.th||0, BL:p.bl||0, "2P":p.susp?1:0
  })));
  const meta = XLSX.utils.json_to_sheet([{Meccs:state.matchName||'', D√°tum:state.matchDate||'', F√©lid≈ë:state.half, Id≈ë: toMMSS((state.half===1?0:1800)+state.elapsed)}]);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, teamSheet('A'), 'Csapat A');
  XLSX.utils.book_append_sheet(wb, teamSheet('B'), 'Csapat B');
  XLSX.utils.book_append_sheet(wb, meta, 'Meta');
  const d=(state.matchDate||todayStr()); const m=(state.matchName||'meccs').replace(/[^\w\d\- ]+/g,'_').slice(0,50);
  XLSX.writeFile(wb, `kezistats_${d}_${m}.xlsx`);
}
$('exportXlsxBtn').onclick=exportXLSX;

/* PDF export */
async function exportPDF(){
  if(typeof window.jspdf==='undefined'||typeof window.jspdf.jsPDF==='undefined') return alert('jsPDF k√∂nyvt√°r nem el√©rhet≈ë.');
  const { jsPDF }=window.jspdf;
  const doc=new jsPDF('l','pt','a4');
  const title=`K√©zilabda stat ‚Äì ${state.matchName||''} (${state.matchDate||''})`;
  doc.setFontSize(14); doc.text(title,40,40);
  function teamTable(side,y){
    const head=[['#','N√©v','ON','MIN','L√∂v','G√≥l','%','7A','7G','7%','TH','BL','2P']];
    const body=state[side].players.map(p=>[
      p.num||'', p.name||'', (p.on?'ON':'OFF'), toMMSS(p.tocSec||0), p.shots||0, p.goals||0,
      (p.shots?Math.round(p.goals/p.shots*100):0)+'%', p.p7a||0, p.p7g||0, (p.p7a?Math.round(p.p7g/p.p7a*100):0)+'%', p.th||0, p.bl||0, p.susp?'x':''
    ]);
    doc.autoTable({head,body,startY:y,theme:'grid',styles:{fontSize:8,cellPadding:3},headStyles:{fillColor:[27,92,255]},margin:{left:40,right:40}});
    return doc.lastAutoTable.finalY||y;
  }
  let y=70; doc.setFontSize(12); doc.text('Csapat A',40,y); y=teamTable('A',y+4)+16;
  doc.setFontSize(12); doc.text('Csapat B',40,y); teamTable('B',y+4);
  const d=(state.matchDate||todayStr()); const m=(state.matchName||'meccs').replace(/[^\w\d\- ]+/g,'_').slice(0,50);
  doc.save(`kezistats_${d}_${m}.pdf`);
}
$('exportPdfBtn').onclick=exportPDF;

/* S√∫g√≥ */
$('helpBtn').onclick=()=> $('helpModal').style.display='block';
$('helpCloseBtn').onclick=()=> $('helpModal').style.display='none';

/* Init */
$('matchDate').value=state.matchDate;
$('matchName').oninput=e=>{ state.matchName=e.target.value; };
$('matchDate').onchange=e=>{ state.matchDate=e.target.value; };

function renderInitialPlayers(side){
  // indul√°skor 14 √ºres sor legyen k√∂nny≈± szerkeszt√©ssel
  for(let i=0;i<14;i++){ state[side].players[i].num = state[side].players[i].num || String(i+1); }
}
renderInitialPlayers('A'); renderInitialPlayers('B');
populatePicker('A'); populatePicker('B');
renderAll();

/* Auto-ment√©s 2 percenk√©nt */
setInterval(()=>{ try{ const key=makeStorageKey()+"_auto"; localStorage.setItem(key, JSON.stringify({savedAt:Date.now(),data:snapshot()})); }catch{} }, 120000);

</script>
</body>
</html>
