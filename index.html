<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K√©zilabda stat ‚Äì V4 (k√©t csapat, export, ment√©sek, offline, undo, TOC)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1b5cff">

<!-- Export k√∂nyvt√°rak (els≈ë bet√∂lt√©sn√©l net kell; ut√°na a service worker cache-eli) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0b0c0f; --panel:#0f1218; --card:#101522; --muted:#94a3b8; --text:#e6edf6;
    --accent:#1b5cff; --accent2:#16a34a; --warn:#f59e0b; --danger:#ef4444; --border:#1f283a; --chip:#0f1a2a;
  }
  body{ margin:0; background:var(--bg); color:var(--text);
        font:11px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .topbar{ position:sticky; top:0; z-index:70; background:var(--panel); border-bottom:1px solid var(--border); }
  .wrap{ max-width:1200px; margin:0 auto; padding:6px 8px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:12px; padding-right:6px; }
  .pill{ display:flex; gap:4px; align-items:center; padding:3px 6px; border:1px solid var(--border); background:var(--chip); border-radius:6px; }
  .pill input, .pill select{ border:0; background:transparent; outline:none; color:var(--text); font-size:11px; min-width:110px; }
  .timer{ font-variant-numeric:tabular-nums; font-size:14px; font-weight:800; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:var(--card); }
  .btn{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:6px; padding:3px 6px; cursor:pointer; font-size:11px; display:inline-flex; align-items:center; gap:4px;}
  .btn.pri{ background:var(--accent); color:#fff; }
  .btn.ok{ background:var(--accent2); color:#fff; }
  .btn.warn{ background:var(--warn); color:#fff; }
  .btn.dan{ background:var(--danger); color:#fff; }
  .g{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

  .container{ max-width:1200px; margin:10px auto; padding:0 8px; display:grid; gap:8px; }
  .scorebar{ display:flex; align-items:center; justify-content:center; gap:14px; flex-wrap:wrap; }
  .score{ font-size:18px; font-weight:900; padding:2px 8px; border-radius:8px; border:1px solid var(--border); background:var(--panel); }

  .grid{ display:grid; grid-template-columns:1fr; gap:8px; }
  @media(min-width:980px){ .grid{ grid-template-columns:1fr 1fr; } }
  .card{ border:1px solid var(--border); border-radius:8px; background:var(--card); }
  .inner{ padding:8px; }

  .teamhdr{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .teamleft{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .teamlogo{ width:28px; height:28px; border-radius:6px; border:1px solid var(--border); background:#0003; object-fit:cover; }

  .table-wrap{ overflow:auto; border-radius:6px; border:1px solid var(--border); }
  table{ width:100%; border-collapse:collapse; font-size:10.5px; table-layout:fixed; }
  thead th{ position:sticky; top:0; background:var(--panel); border-bottom:1px solid var(--border);
            padding:2px 4px; text-align:center; font-weight:800; z-index:2; }
  tbody td{ border-bottom:1px solid var(--border); padding:1px 3px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  td.left, th.left{ text-align:left; }
  tfoot td{ padding:2px 4px; font-weight:800; background:var(--panel); }
  .namecell{ display:flex; gap:3px; align-items:center; }
  .num{ width:2.6rem; text-align:center; padding:2px 3px; border:1px solid var(--border); border-radius:4px; background:var(--panel); color:var(--text); font-size:10.5px; }
  .name{ flex:1; min-width:80px; padding:2px 4px; border:1px solid var(--border); border-radius:4px; background:var(--panel); color:var(--text); font-size:10.5px; }
  .enroll{ width:1.2rem; height:1.2rem; }
  .inactive{ opacity:.55; }
  .sticky-col{ position:sticky; left:0; z-index:1; background:var(--card); }
  .sticky-col::after{ content:""; position:absolute; right:-1px; top:0; bottom:0; width:1px; background:var(--border); }

  .density-cozy table{ font-size:11px; }
  .density-compact table{ font-size:10.5px; }
  .density-ultra table{ font-size:9.8px; }
  .density-ultra .num,.density-ultra .name{ font-size:9.8px; padding:1px 3px; }
  .density-ultra tbody td{ padding:1px 2px; }

  .hint{ color:var(--muted); font-size:10px; }

  /* mini ikonok */
  .i{font-size:14px; line-height:1;}

  /* TOC */
  .onbtn{ cursor:pointer; padding:2px 6px; border-radius:6px; border:1px solid var(--border); font-weight:700; }
  .onbtn.on{ background:#16a34a; color:#fff; }
  .onbtn.off{ background:#6b7280; color:#fff; }
  .susp-badge{ display:inline-block; padding:0 6px; border-radius:999px; background:#ef4444; color:#fff; font-weight:800; margin-left:6px; }
</style>
</head>
<body class="density-ultra">

  <!-- Fels≈ë vez√©rl≈ës√°v -->
  <div class="topbar">
    <div class="wrap g">
      <div class="brand">K√©zilabda stat ‚Äì V4</div>
      <span class="pill">M√©rk≈ëz√©s: <input id="matchName" placeholder="Pl. Veszpr√©m‚ÄìSzeged"></span>
      <span class="pill">D√°tum: <input id="matchDate" type="date"></span>
      <span class="pill">F√©lid≈ë: <span id="halfLabel">1.</span></span>
      <span class="timer" id="clock">30:00</span>
      <button class="btn pri" id="startBtn" title="Start"><span class="i">‚ñ∂Ô∏é</span></button>
      <button class="btn" id="pauseBtn" title="Pauza"><span class="i">‚è∏Ô∏é</span></button>
      <button class="btn" id="resetClockBtn" title="√ìra 30:00"><span class="i">‚è±Ô∏è</span>30:00</button>

      <div class="pill g">
        Hosszabb√≠t√°s:
        <button class="btn" data-et="+60" title="+1:00">+1</button>
        <button class="btn" data-et="+300" title="+5:00">+5</button>
        <button class="btn" id="etCustom" title="Egyedi‚Ä¶">‚ãØ</button>
      </div>

      <button class="btn warn" id="switchHalfBtn" title="F√©lid≈ë v√°lt√°s"><span class="i">‚Üª</span> F√©lid≈ë</button>

      <span class="pill">S≈±r≈±s√©g:
        <select id="densitySel">
          <option value="density-cozy">Cozy</option>
          <option value="density-compact">Compact</option>
          <option value="density-ultra" selected>Ultra</option>
        </select>
      </span>

      <span class="pill">Csak A csapat:
        <input type="checkbox" id="singleTeamToggle" />
      </span>

      <span class="pill">TOC m√≥d:
        <select id="tocModeSel" title="Egyszer≈±: nevezett = p√°ly√°n; R√©szletes: ON/OFF gomb">
          <option value="simple" selected>Egyszer≈±</option>
          <option value="detailed">R√©szletes</option>
        </select>
      </span>

      <button class="btn" id="undoBtn" title="Visszavon√°s"><span class="i">‚Ü©</span><span id="undoLabel"> Visszavon√°s</span></button>
      <button class="btn dan" id="hardResetBtn" title="Alaphelyzet"><span class="i">üóëÔ∏è</span></button>

      <button class="btn" id="saveMatchBtn" title="Ment√©s meccsk√©nt"><span class="i">üíæ</span></button>
      <button class="btn" id="openMatchesBtn" title="Mentett m√©rk≈ëz√©sek"><span class="i">üìÇ</span></button>

      <button class="btn" id="exportExcelBtn" title="Excel export"><span class="i">üßæ</span> XLSX</button>
      <button class="btn" id="exportPdfBtn" title="PDF export"><span class="i">üìÑ</span> PDF</button>

      <button class="btn" id="backupBtn" title="Biztons√°gi ment√©s"><span class="i">üíæ</span> JSON</button>
      <button class="btn" id="restoreBtn" title="Vissza√°ll√≠t√°s"><span class="i">üìÇ</span> JSON</button>
    </div>
  </div>

  <div class="container">
    <!-- Eredm√©nyjelz≈ë + csapatnevek/log√≥k -->
    <div class="card">
      <div class="inner scorebar">
        <div class="g">
          <img id="logoA" class="teamlogo" alt="A log√≥">
          <span class="pill">Hazai: <input id="teamAName" placeholder="Csapat A"></span>
          <label class="pill">Log√≥: <input id="logoAInput" type="file" accept="image/*"></label>
          <span class="pill">Csapat bet√∂lt√©s:
            <select id="loadTeamA"></select>
            <button class="btn" id="loadTeamABtn" title="Bet√∂lt"><span class="i">‚¨á</span></button>
            <button class="btn" id="saveTeamABtn" title="Ment√©s"><span class="i">‚¨Ü</span></button>
          </span>
        </div>

        <div class="score" id="scoreBoard">0 : 0</div>

        <div class="g" id="teamBHeader">
          <img id="logoB" class="teamlogo" alt="B log√≥">
          <span class="pill">Vend√©g: <input id="teamBName" placeholder="Csapat B"></span>
          <label class="pill">Log√≥: <input id="logoBInput" type="file" accept="image/*"></label>
          <span class="pill">Csapat bet√∂lt√©s:
            <select id="loadTeamB"></select>
            <button class="btn" id="loadTeamBBtn" title="Bet√∂lt"><span class="i">‚¨á</span></button>
            <button class="btn" id="saveTeamBBtn" title="Ment√©s"><span class="i">‚¨Ü</span></button>
          </span>
        </div>
      </div>
    </div>

    <!-- K√©t t√°bla egym√°s mellett -->
    <div class="grid" id="tablesGrid">
      <!-- CSAPAT A -->
      <div class="card">
        <div class="inner teamhdr">
          <div class="teamleft">
            <span class="pill">J√°t√©kos (A):
              <select id="pickerA"></select>
            </span>
            <button class="btn ok" id="thA" title="Technikai hiba +">TH +</button>
            <button class="btn" id="blA" title="Blokk +">BL +</button>
            <button class="btn warn" id="s2a" title="2 perc kezdete (kiv√°lasztott)">2P KEZD</button>
            <button class="btn" id="e2a" title="2 perc v√©ge (kiv√°lasztott)">2P V√âGE</button>
          </div>
          <div class="g">
            <button class="btn" id="lockA">N√©vjegyz√©k lez√°r</button>
            <button class="btn" id="allOnA">√ñsszes be</button>
            <button class="btn" id="allOffA">√ñsszes ki</button>
            <button class="btn" id="pasteA">Gyors keret</button>
          </div>
        </div>

        <div class="inner table-wrap">
          <table>
            <thead>
              <tr>
                <th class="left sticky-col" style="width:220px">‚úì # / N√©v (A)</th>
                <th style="width:40px">ON</th>
                <th style="width:72px">MIN</th>
                <th style="width:52px">L√∂v</th>
                <th style="width:52px">G√≥l</th>
                <th style="width:44px">%</th>
                <th style="width:44px">7A</th>
                <th style="width:44px">7G</th>
                <th style="width:44px">7%</th>
                <th style="width:52px">TH</th>
                <th style="width:52px">BL</th>
              </tr>
            </thead>
            <tbody id="bodyA"></tbody>
            <tfoot>
              <tr>
                <td class="left sticky-col">√ñsszesen (nevezettek)</td>
                <td></td><td></td>
                <td id="aShots">0</td>
                <td id="aGoals">0</td>
                <td id="aPct">0%</td>
                <td id="aP7A">0</td>
                <td id="aP7G">0</td>
                <td id="aP7Pct">0%</td>
                <td id="aTH">0</td>
                <td id="aBL">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="inner hint">Egyszer≈± m√≥d: nevezett = p√°ly√°n. R√©szletes m√≥d: ON gombbal sz√°moljuk a p√°lyaid≈ët. 2P alatt a MIN nem ketyeg.</div>
      </div>

      <!-- CSAPAT B -->
      <div class="card" id="teamBCard">
        <div class="inner teamhdr">
          <div class="teamleft">
            <span class="pill">J√°t√©kos (B):
              <select id="pickerB"></select>
            </span>
            <button class="btn ok" id="thB" title="Technikai hiba +">TH +</button>
            <button class="btn" id="blB" title="Blokk +">BL +</button>
            <button class="btn warn" id="s2b" title="2 perc kezdete (kiv√°lasztott)">2P KEZD</button>
            <button class="btn" id="e2b" title="2 perc v√©ge (kiv√°lasztott)">2P V√âGE</button>
          </div>
          <div class="g">
            <button class="btn" id="lockB">N√©vjegyz√©k lez√°r</button>
            <button class="btn" id="allOnB">√ñsszes be</button>
            <button class="btn" id="allOffB">√ñsszes ki</button>
            <button class="btn" id="pasteB">Gyors keret</button>
          </div>
        </div>

        <div class="inner table-wrap">
          <table>
            <thead>
              <tr>
                <th class="left sticky-col" style="width:220px">‚úì # / N√©v (B)</th>
                <th style="width:40px">ON</th>
                <th style="width:72px">MIN</th>
                <th style="width:52px">L√∂v</th>
                <th style="width:52px">G√≥l</th>
                <th style="width:44px">%</th>
                <th style="width:44px">7A</th>
                <th style="width:44px">7G</th>
                <th style="width:44px">7%</th>
                <th style="width:52px">TH</th>
                <th style="width:52px">BL</th>
              </tr>
            </thead>
            <tbody id="bodyB"></tbody>
            <tfoot>
              <tr>
                <td class="left sticky-col">√ñsszesen (nevezettek)</td>
                <td></td><td></td>
                <td id="bShots">0</td>
                <td id="bGoals">0</td>
                <td id="bPct">0%</td>
                <td id="bP7A">0</td>
                <td id="bP7G">0</td>
                <td id="bP7Pct">0%</td>
                <td id="bTH">0</td>
                <td id="bBL">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="inner hint">Egyszer≈± m√≥d: nevezett = p√°ly√°n. R√©szletes m√≥d: ON gombbal sz√°moljuk a p√°lyaid≈ët. 2P alatt a MIN nem ketyeg.</div>
      </div>
    </div>
  </div>

  <!-- Mentett m√©rk≈ëz√©sek modal -->
  <div class="modal" id="matchesModal">
    <div class="box">
      <div class="row">
        <strong>Mentett m√©rk≈ëz√©sek</strong>
        <span class="pill">Keres√©s: <input id="searchMatches" placeholder="d√°tum / csapat / j√°t√©kos"></span>
        <span class="g" style="margin-left:auto">
          <button class="btn" id="closeMatches">Bez√°r</button>
        </span>
      </div>
      <div class="list">
        <table id="matchesTable" style="width:100%">
          <thead><tr><th>D√°tum</th><th>M√©rk≈ëz√©s</th><th>Csapatok</th><th>M≈±velet</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ====== √ÅLLAND√ìK / T√ÅROL√ìK ====== */
const MAXP = 20;
const UNDO_LIMIT = 10;

const LS_STATE   = 'hb_dual_v4_state';
const LS_MATCHES = 'hb_dual_v4_matches';
const LS_TEAMS   = 'hb_dual_v4_teams';

const $ = (id)=>document.getElementById(id);
const pct=(n,d)=> d? (Math.round((n/d*1000))/10).toFixed(1)+"%":"0%";
const toMMSS = (sec)=>{ sec=Math.max(0,Math.floor(sec)); const m=Math.floor(sec/60), s=sec%60; return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0'); };

/* ====== ALAP √ÅLLAPOT ====== */
const emptyPlayer = ()=>({active:true,num:"",name:"",shots:0,goals:0,p7a:0,p7g:0,th:0,bl:0, on:false, tocSec:0, susp:false});
const emptyTeam = ()=>({locked:false, name:"", logo:"", players:Array.from({length:MAXP}, emptyPlayer)});

let state = JSON.parse(localStorage.getItem(LS_STATE)) || {
  matchName:"", matchDate: todayStr(), currentHalf:1, remainingSeconds:30*60,
  singleTeam:false,
  tocMode:'simple', // 'simple' | 'detailed'
  A: emptyTeam(), B: emptyTeam()
};
let matches = JSON.parse(localStorage.getItem(LS_MATCHES) || '[]');
let teams   = JSON.parse(localStorage.getItem(LS_TEAMS) || '[]'); // [{name,logo,players:[{num,name}],updatedAt}]
let undoStack = []; // {side,index,field,delta,label}
let tmr=null;

/* ====== SEG√âD ====== */
function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
function saveAll(){
  localStorage.setItem(LS_STATE, JSON.stringify(state));
  localStorage.setItem(LS_MATCHES, JSON.stringify(matches));
  localStorage.setItem(LS_TEAMS, JSON.stringify(teams));
}
function readLogo(file, cb){
  if(!file) return;
  const r=new FileReader();
  r.onload=()=> cb(r.result);
  r.readAsDataURL(file);
}
function pushUndo(side,index,field,delta,label){
  undoStack.unshift({side,index,field,delta,label});
  if(undoStack.length>UNDO_LIMIT) undoStack.pop();
  updateUndoLabel();
}
function updateUndoLabel(){
  const u = undoStack[0];
  $('undoLabel').textContent = u ? ` ${u.label}` : ' Visszavon√°s';
  $('undoBtn').disabled = !u;
}

/* ====== TOC ‚Äì felt√©tel, hogy ketyeg-e ====== */
function isOnCourt(p){
  // Egyszer≈±: nevezett; R√©szletes: ON gomb; mindkett≈ët meg√°ll√≠tja a 'susp' (2P)
  if(p.susp) return false;
  return (state.tocMode==='simple') ? !!p.active : !!p.on;
}

/* ====== TOC ‚Äì perces tick ====== */
function tickToC(){
  if(!tmr) return; // √≥ra nem fut
  ['A','B'].forEach(side=>{
    state[side].players.forEach(p=>{
      if(isOnCourt(p)) p.tocSec = (p.tocSec||0) + 1;
    });
  });
}

/* ====== RENDER ====== */
function renderAll(){
  $('matchName').value = state.matchName||"";
  $('matchDate').value = state.matchDate||todayStr();
  $('halfLabel').textContent = state.currentHalf===1 ? "1." : "2.";
  $('singleTeamToggle').checked = !!state.singleTeam;
  $('tocModeSel').value = state.tocMode||'simple';
  updateClock();

  $('teamAName').value = state.A.name||"";
  $('teamBName').value = state.B.name||"";
  $('logoA').src = state.A.logo || "";
  $('logoB').src = state.B.logo || "";

  document.getElementById('teamBHeader').style.display = state.singleTeam ? 'none' : '';
  document.getElementById('teamBCard').style.display   = state.singleTeam ? 'none' : '';

  renderTeam('A'); renderTeam('B');
  populateTeamSelectors();
  updateScore();
  updateUndoLabel();
}

/* ====== CSAPAT RENDER ====== */
function totals(team){
  const on = team.players.filter(p=>p.active);
  const shots=on.reduce((a,p)=>a+p.shots,0);
  const goals=on.reduce((a,p)=>a+p.goals,0);
  const p7a  =on.reduce((a,p)=>a+p.p7a,0);
  const p7g  =on.reduce((a,p)=>a+p.p7g,0);
  const th   =on.reduce((a,p)=>a+p.th,0);
  const bl   =on.reduce((a,p)=>a+p.bl,0);
  return {shots,goals,p7a,p7g,th,bl};
}
function addCellTD(val, onPlus){
  const td=document.createElement('td'); td.textContent=val; td.style.cursor='pointer'; td.title='+1';
  td.addEventListener('click', onPlus);
  return td;
}
function renderTeam(side){
  const team = state[side];
  const body = side==='A' ? $('bodyA') : $('bodyB');
  body.innerHTML="";

  team.players.forEach((p,i)=>{
    const tr=document.createElement('tr');
    if(!p.active) tr.classList.add('inactive');

    // els≈ë oszlop: checkbox + # + n√©v
    const td=document.createElement('td'); td.className='left sticky-col';
    if(team.locked){
      td.innerHTML = `
        <div class="namecell">
          <input type="checkbox" class="enroll" ${p.active?'checked':''} data-side="${side}" data-i="${i}">
          <span style="width:2.6rem;display:inline-block;text-align:center;">${p.num||""}</span>
          <span style="flex:1;min-width:80px;overflow:hidden;text-overflow:ellipsis">${p.name||""}</span>
        </div>`;
      td.querySelector('.enroll').addEventListener('change',(e)=>{
        p.active=e.target.checked; updateScore(); saveAll(); renderTeam(side);
      });
    }else{
      const wrap=document.createElement('div'); wrap.className='namecell';
      const chk=document.createElement('input'); chk.type='checkbox'; chk.className='enroll'; chk.checked=p.active;
      chk.addEventListener('change',()=>{ p.active=chk.checked; updateScore(); saveAll(); renderTeam(side); });
      const num=document.createElement('input'); num.className='num'; num.placeholder='#'; num.value=p.num;
      const name=document.createElement('input'); name.className='name'; name.placeholder='N√©v'; name.value=p.name;
      num.addEventListener('input',()=>{ p.num=num.value; populatePicker(side); saveAll(); });
      name.addEventListener('input',()=>{ p.name=name.value; populatePicker(side); saveAll(); });
      wrap.append(chk,num,name); td.appendChild(wrap);
    }
    tr.appendChild(td);

    // ON gomb
    const tdOn=document.createElement('td');
    const btn=document.createElement('button');
    btn.className='onbtn ' + (p.on?'on':'off');
    btn.textContent = p.on ? 'ON' : 'OFF';
    btn.title = 'P√°ly√°ra / padr√≥l';
    btn.disabled = (state.tocMode!=='detailed'); // egyszer≈± m√≥dban kikapcsolva
    btn.style.opacity = (state.tocMode==='detailed') ? '1' : '.5';
    btn.addEventListener('click', ()=>{
      p.on = !p.on;
      renderTeam(side); saveAll();
    });
    tdOn.appendChild(btn);
    tr.appendChild(tdOn);

    // MIN kijelz≈ë + 2P badge
    const tdMin=document.createElement('td');
    tdMin.textContent = toMMSS(p.tocSec||0);
    if(p.susp){
      const b=document.createElement('span'); b.className='susp-badge'; b.textContent='2P';
      tdMin.appendChild(b);
    }
    tr.appendChild(tdMin);

    // stat cell√°k
    const addAndRerender = (fn)=>()=>{ fn(); renderTeam(side); updateScore(); saveAll(); };

    tr.appendChild(addCellTD(p.shots, addAndRerender(()=>{ p.shots++; pushUndo(side,i,'shots',-1,`L√∂v√©s: ${side} #${p.num||i+1} ${p.name||''}`); })));
    tr.appendChild(addCellTD(p.goals, addAndRerender(()=>{ p.goals++; p.shots++; pushUndo(side,i,'combo_goal',-1,`G√≥l: ${side} #${p.num||i+1} ${p.name||''}`); })));
    const tdPct=document.createElement('td'); tdPct.textContent=pct(p.goals,p.shots); tr.appendChild(tdPct);
    tr.appendChild(addCellTD(p.p7a,  addAndRerender(()=>{ p.p7a++; p.shots++; pushUndo(side,i,'combo_7a',-1,`7A: ${side} #${p.num||i+1} ${p.name||''}`); })));
    tr.appendChild(addCellTD(p.p7g,  addAndRerender(()=>{ p.p7g++; p.p7a++; p.shots++; p.goals++; pushUndo(side,i,'combo_7g',-1,`7G: ${side} #${p.num||i+1} ${p.name||''}`); })));
    const td7p=document.createElement('td'); td7p.textContent=pct(p.p7g,p.p7a); tr.appendChild(td7p);
    tr.appendChild(addCellTD(p.th,   addAndRerender(()=>{ p.th++; pushUndo(side,i,'th',-1,`TH: ${side} #${p.num||i+1} ${p.name||''}`); })));
    tr.appendChild(addCellTD(p.bl,   addAndRerender(()=>{ p.bl++; pushUndo(side,i,'bl',-1,`BL: ${side} #${p.num||i+1} ${p.name||''}`); })));

    body.appendChild(tr);
  });

  // totals
  const t=totals(team);
  (side==='A'?$('aShots'):$('bShots')).textContent=t.shots;
  (side==='A'?$('aGoals'):$('bGoals')).textContent=t.goals;
  (side==='A'?$('aPct')  :$('bPct')).textContent=pct(t.goals,t.shots);
  (side==='A'?$('aP7A')  :$('bP7A')).textContent=t.p7a;
  (side==='A'?$('aP7G')  :$('bP7G')).textContent=t.p7g;
  (side==='A'?$('aP7Pct'):$('bP7Pct')).textContent=pct(t.p7g,t.p7a);
  (side==='A'?$('aTH')   :$('bTH')).textContent=t.th;
  (side==='A'?$('aBL')   :$('bBL')).textContent=t.bl;

  populatePicker(side);
  (side==='A'?$('lockA'):$('lockB')).textContent = team.locked ? 'N√©vjegyz√©k felold' : 'N√©vjegyz√©k lez√°r';
}

/* ====== PICKEREK & SELECT ALL ====== */
function populatePicker(side){
  const team=state[side]; const pick=side==='A'?$('pickerA'):$('pickerB'); const sel=pick.value;
  pick.innerHTML="";
  team.players.forEach((p,i)=>{
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent=`${p.num||i+1} ‚Äì ${p.name||("J√°t√©kos "+(i+1))}`;
    pick.appendChild(o);
  });
  if(sel) pick.value=sel;
}
$('allOnA').addEventListener('click',()=>{
  state.A.players.forEach(p=>{ p.active=true; if(state.tocMode==='detailed') p.on=true; });
  renderTeam('A'); updateScore(); saveAll();
});
$('allOffA').addEventListener('click',()=>{
  state.A.players.forEach(p=>{ p.active=false; if(state.tocMode==='detailed') p.on=false; });
  renderTeam('A'); updateScore(); saveAll();
});
$('allOnB').addEventListener('click',()=>{
  state.B.players.forEach(p=>{ p.active=true; if(state.tocMode==='detailed') p.on=true; });
  renderTeam('B'); updateScore(); saveAll();
});
$('allOffB').addEventListener('click',()=>{
  state.B.players.forEach(p=>{ p.active=false; if(state.tocMode==='detailed') p.on=false; });
  renderTeam('B'); updateScore(); saveAll();
});

/* ====== 2 PERC: gombok a kiv√°lasztottra ====== */
$('s2a').addEventListener('click', ()=>{
  const i=parseInt($('pickerA').value||'0',10);
  const p=state.A.players[i]; p.susp=true;
  if(state.tocMode==='detailed') p.on=false; // opcion√°lis: automatikusan lekapcsoljuk az ON-t
  renderTeam('A'); saveAll();
});
$('e2a').addEventListener('click', ()=>{
  const i=parseInt($('pickerA').value||'0',10);
  state.A.players[i].susp=false;
  renderTeam('A'); saveAll();
});
$('s2b').addEventListener('click', ()=>{
  const i=parseInt($('pickerB').value||'0',10);
  const p=state.B.players[i]; p.susp=true;
  if(state.tocMode==='detailed') p.on=false;
  renderTeam('B'); saveAll();
});
$('e2b').addEventListener('click', ()=>{
  const i=parseInt($('pickerB').value||'0',10);
  state.B.players[i].susp=false;
  renderTeam('B'); saveAll();
});

/* ====== SCORE ====== */
function updateScore(){
  const a=totals(state.A).goals;
  const b= state.singleTeam ? 0 : totals(state.B).goals;
  $('scoreBoard').textContent=`${a} : ${b}`;
}

/* ====== √ìRA + HOSSZABB√çT√ÅS ====== */
function updateClock(){
  const m=Math.floor(state.remainingSeconds/60), s=state.remainingSeconds%60;
  $('clock').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
let tmr=null;
function start(){
  if(tmr) return;
  tmr=setInterval(()=>{
    state.remainingSeconds=Math.max(0,state.remainingSeconds-1);
    updateClock();

    // TOC tick ‚Äì itt nem ketyeg annak, aki 'susp' st√°tuszban van
    tickToC();

    if(state.remainingSeconds===0){
      pause();
      alert((state.currentHalf===1?"1.":"2.")+" f√©lid≈ë v√©ge");
    }
    saveAll();

    // friss√≠tj√ºk a t√°bl√°kat, hogy a MIN l√°tsz√≥djon
    renderTeam('A'); if(!state.singleTeam) renderTeam('B');
  },1000);
}
function pause(){ if(!tmr) return; clearInterval(tmr); tmr=null; }
function reset30(){ pause(); state.remainingSeconds=30*60; updateClock(); saveAll(); }
function addExtra(sec){ state.remainingSeconds += sec; if(state.remainingSeconds<0) state.remainingSeconds=0; updateClock(); saveAll(); }
function switchHalf(){ pause(); state.currentHalf=state.currentHalf===1?2:1; reset30(); renderAll(); }

/* ====== INPUTOK / GOMBOK ====== */
$('matchName').addEventListener('input', e=>{ state.matchName=e.target.value; saveAll(); });
$('matchDate').value = state.matchDate || todayStr();
$('matchDate').addEventListener('input', e=>{ state.matchDate=e.target.value; saveAll(); });
$('teamAName').addEventListener('input', e=>{ state.A.name=e.target.value; saveAll(); });
$('teamBName').addEventListener('input', e=>{ state.B.name=e.target.value; saveAll(); });
$('logoAInput').addEventListener('change', e=> readLogo(e.target.files?.[0], data=>{ state.A.logo=data; $('logoA').src=data; saveAll(); }));
$('logoBInput').addEventListener('change', e=> readLogo(e.target.files?.[0], data=>{ state.B.logo=data; $('logoB').src=data; saveAll(); }));

$('startBtn').addEventListener('click', start);
$('pauseBtn').addEventListener('click', pause);
$('resetClockBtn').addEventListener('click', reset30);
$('switchHalfBtn').addEventListener('click', switchHalf);
document.querySelectorAll('[data-et]').forEach(b=> b.addEventListener('click', ()=> addExtra(parseInt(b.getAttribute('data-et'),10))));
$('etCustom').addEventListener('click', ()=>{ const mm=prompt("H√°ny percet adjak hozz√°? (perc)"); if(mm===null) return; const m=parseInt(mm,10); if(!isNaN(m)) addExtra(m*60); });

$('singleTeamToggle').addEventListener('change', (e)=>{ state.singleTeam = e.target.checked; renderAll(); saveAll(); });
$('tocM
