<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>K√©zilabda stat ‚Äì V4 (k√©t csapat, export, ment√©sek, offline, undo)</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1b5cff">

<!-- Export k√∂nyvt√°rak (els≈ë bet√∂lt√©sn√©l net kell; ut√°na a service worker cache-eli) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.1/dist/jspdf.plugin.autotable.min.js"></script>

<style>
  :root{
    --bg:#0b0c0f; --panel:#0f1218; --card:#101522; --muted:#94a3b8; --text:#e6edf6;
    --accent:#1b5cff; --accent2:#16a34a; --warn:#f59e0b; --danger:#ef4444; --border:#1f283a; --chip:#0f1a2a;
  }
  body{ margin:0; background:var(--bg); color:var(--text);
        font:11px/1.2 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
  .topbar{ position:sticky; top:0; z-index:70; background:var(--panel); border-bottom:1px solid var(--border); }
  .wrap{ max-width:1200px; margin:0 auto; padding:6px 8px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
  .brand{ font-weight:800; letter-spacing:.2px; font-size:12px; padding-right:6px; }
  .pill{ display:flex; gap:4px; align-items:center; padding:3px 6px; border:1px solid var(--border); background:var(--chip); border-radius:6px; }
  .pill input, .pill select{ border:0; background:transparent; outline:none; color:var(--text); font-size:11px; min-width:110px; }
  .timer{ font-variant-numeric:tabular-nums; font-size:14px; font-weight:800; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:var(--card); }
  .btn{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:6px; padding:3px 6px; cursor:pointer; font-size:11px; display:inline-flex; align-items:center; gap:4px;}
  .btn.pri{ background:var(--accent); color:#fff; }
  .btn.ok{ background:var(--accent2); color:#fff; }
  .btn.warn{ background:var(--warn); color:#fff; }
  .btn.dan{ background:var(--danger); color:#fff; }
  .g{ display:flex; gap:6px; align-items:center; flex-wrap:wrap; }

  .container{ max-width:1200px; margin:10px auto; padding:0 8px; display:grid; gap:8px; }
  .scorebar{ display:flex; align-items:center; justify-content:center; gap:14px; flex-wrap:wrap; }
  .score{ font-size:18px; font-weight:900; padding:2px 8px; border-radius:8px; border:1px solid var(--border); background:var(--panel); }

  .grid{ display:grid; grid-template-columns:1fr; gap:8px; }
  @media(min-width:980px){ .grid{ grid-template-columns:1fr 1fr; } }
  .card{ border:1px solid var(--border); border-radius:8px; background:var(--card); }
  .inner{ padding:8px; }

  .teamhdr{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
  .teamleft{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .teamlogo{ width:28px; height:28px; border-radius:6px; border:1px solid var(--border); background:#0003; object-fit:cover; }

  .table-wrap{ overflow:auto; border-radius:6px; border:1px solid var(--border); }
  table{ width:100%; border-collapse:collapse; font-size:10.5px; table-layout:fixed; }
  thead th{ position:sticky; top:0; background:var(--panel); border-bottom:1px solid var(--border);
            padding:2px 4px; text-align:center; font-weight:800; z-index:2; }
  tbody td{ border-bottom:1px solid var(--border); padding:1px 3px; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  td.left, th.left{ text-align:left; }
  tfoot td{ padding:2px 4px; font-weight:800; background:var(--panel); }
  .namecell{ display:flex; gap:3px; align-items:center; }
  .num{ width:2.6rem; text-align:center; padding:2px 3px; border:1px solid var(--border); border-radius:4px; background:var(--panel); color:var(--text); font-size:10.5px; }
  .name{ flex:1; min-width:80px; padding:2px 4px; border:1px solid var(--border); border-radius:4px; background:var(--panel); color:var(--text); font-size:10.5px; }
  .enroll{ width:1.2rem; height:1.2rem; }
  .inactive{ opacity:.55; }
  .sticky-col{ position:sticky; left:0; z-index:1; background:var(--card); }
  .sticky-col::after{ content:""; position:absolute; right:-1px; top:0; bottom:0; width:1px; background:var(--border); }

  .playcell{ display:flex; flex-direction:column; align-items:center; gap:2px; }
  .play-toggle{ width:22px; height:22px; border-radius:50%; border:1px solid var(--border);
                background:var(--panel); color:var(--text); cursor:pointer; font-size:12px; line-height:1; }
  .play-toggle.on{ background:var(--accent2); color:#fff; }
  .playtime{ font-variant-numeric:tabular-nums; font-size:10px; }

  .density-cozy table{ font-size:11px; }
  .density-compact table{ font-size:10.5px; }
  .density-ultra table{ font-size:9.8px; }
  .density-ultra .num,.density-ultra .name{ font-size:9.8px; padding:1px 3px; }
  .density-ultra tbody td{ padding:1px 2px; }

  .hint{ color:var(--muted); font-size:10px; }

  /* modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:80; }
  .modal .box{ width:min(900px,95vw); max-height:85vh; overflow:auto; background:var(--card); border:1px solid var(--border); border-radius:10px; padding:12px; }
  .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
  .list{ border:1px solid var(--border); border-radius:8px; overflow:auto; max-height:60vh; }
  .list table{ table-layout:auto; }
  .list th,.list td{ padding:6px 8px; }

  /* mini ikonok */
  .i{font-size:14px; line-height:1;}
</style>
</head>
<body class="density-ultra">

  <!-- Fels≈ë vez√©rl≈ës√°v -->
  <div class="topbar">
    <div class="wrap g">
      <div class="brand">K√©zilabda stat ‚Äì V4</div>
      <span class="pill">M√©rk≈ëz√©s: <input id="matchName" placeholder="Pl. Veszpr√©m‚ÄìSzeged"></span>
      <span class="pill">D√°tum: <input id="matchDate" type="date"></span>
      <span class="pill">F√©lid≈ë: <span id="halfLabel">1.</span></span>
      <span class="timer" id="clock">30:00</span>
      <button class="btn pri" id="startBtn" title="Start"><span class="i">‚ñ∂Ô∏é</span></button>
      <button class="btn" id="pauseBtn" title="Pauza"><span class="i">‚è∏Ô∏é</span></button>
      <button class="btn" id="resetClockBtn" title="√ìra 30:00"><span class="i">‚è±Ô∏è</span>30:00</button>

      <div class="pill g">
        Hosszabb√≠t√°s:
        <button class="btn" data-et="+60" title="+1:00">+1</button>
        <button class="btn" data-et="+300" title="+5:00">+5</button>
        <button class="btn" id="etCustom" title="Egyedi‚Ä¶">‚ãØ</button>
      </div>

      <button class="btn warn" id="switchHalfBtn" title="F√©lid≈ë v√°lt√°s"><span class="i">‚Üª</span> F√©lid≈ë</button>

      <span class="pill">S≈±r≈±s√©g:
        <select id="densitySel">
          <option value="density-cozy">Cozy</option>
          <option value="density-compact">Compact</option>
          <option value="density-ultra" selected>Ultra</option>
        </select>
      </span>

      <span class="pill">Csak A csapat:
        <input type="checkbox" id="singleTeamToggle" />
      </span>

      <button class="btn" id="undoBtn" title="Visszavon√°s"><span class="i">‚Ü©</span><span id="undoLabel"> Visszavon√°s</span></button>
      <button class="btn dan" id="hardResetBtn" title="Alaphelyzet"><span class="i">üóëÔ∏è</span></button>

      <button class="btn" id="saveMatchBtn" title="Ment√©s meccsk√©nt"><span class="i">üíæ</span></button>
      <button class="btn" id="openMatchesBtn" title="Mentett m√©rk≈ëz√©sek"><span class="i">üìÇ</span></button>

      <button class="btn" id="exportExcelBtn" title="Excel export"><span class="i">üßæ</span> XLSX</button>
      <button class="btn" id="exportPdfBtn" title="PDF export"><span class="i">üìÑ</span> PDF</button>

      <button class="btn" id="backupBtn" title="Biztons√°gi ment√©s"><span class="i">üíæ</span> JSON</button>
      <button class="btn" id="restoreBtn" title="Vissza√°ll√≠t√°s"><span class="i">üìÇ</span> JSON</button>
    </div>
  </div>

  <div class="container">
    <!-- Eredm√©nyjelz≈ë + csapatnevek/log√≥k -->
    <div class="card">
      <div class="inner scorebar">
        <div class="g">
          <img id="logoA" class="teamlogo" alt="A log√≥">
          <span class="pill">Hazai: <input id="teamAName" placeholder="Csapat A"></span>
          <label class="pill">Log√≥: <input id="logoAInput" type="file" accept="image/*"></label>
          <span class="pill">Csapat bet√∂lt√©s:
            <select id="loadTeamA"></select>
            <button class="btn" id="loadTeamABtn" title="Bet√∂lt"><span class="i">‚¨á</span></button>
            <button class="btn" id="saveTeamABtn" title="Ment√©s"><span class="i">‚¨Ü</span></button>
          </span>
        </div>

        <div class="score" id="scoreBoard">0 : 0</div>

        <div class="g" id="teamBHeader">
          <img id="logoB" class="teamlogo" alt="B log√≥">
          <span class="pill">Vend√©g: <input id="teamBName" placeholder="Csapat B"></span>
          <label class="pill">Log√≥: <input id="logoBInput" type="file" accept="image/*"></label>
          <span class="pill">Csapat bet√∂lt√©s:
            <select id="loadTeamB"></select>
            <button class="btn" id="loadTeamBBtn" title="Bet√∂lt"><span class="i">‚¨á</span></button>
            <button class="btn" id="saveTeamBBtn" title="Ment√©s"><span class="i">‚¨Ü</span></button>
          </span>
        </div>
      </div>
    </div>

    <!-- K√©t t√°bla egym√°s mellett -->
    <div class="grid" id="tablesGrid">
      <!-- CSAPAT A -->
      <div class="card">
        <div class="inner teamhdr">
          <div class="teamleft">
            <span class="pill">J√°t√©kos (A):
              <select id="pickerA"></select>
            </span>
            <button class="btn ok" id="thA" title="Technikai hiba +">TH +</button>
            <button class="btn" id="blA" title="Blokk +">BL +</button>
          </div>
          <div class="g">
            <button class="btn" id="lockA">N√©vjegyz√©k lez√°r</button>
            <button class="btn" id="allOnA">√ñsszes be</button>
            <button class="btn" id="allOffA">√ñsszes ki</button>
            <button class="btn" id="pasteA">Gyors keret</button>
          </div>
        </div>

        <div class="inner table-wrap">
          <table>
            <thead>
              <tr>
                <th class="left sticky-col" style="width:220px">‚úì # / N√©v (A)</th>
                <th style="width:70px">P√°lya</th>
                <th style="width:52px">L√∂v</th>
                <th style="width:52px">G√≥l</th>
                <th style="width:44px">%</th>
                <th style="width:44px">7A</th>
                <th style="width:44px">7G</th>
                <th style="width:44px">7%</th>
                <th style="width:52px">TH</th>
                <th style="width:52px">BL</th>
              </tr>
            </thead>
            <tbody id="bodyA"></tbody>
            <tfoot>
              <tr>
                <td class="left sticky-col">√ñsszesen (nevezettek)</td>
                <td id="aPlayTime">00:00</td>
                <td id="aShots">0</td>
                <td id="aGoals">0</td>
                <td id="aPct">0%</td>
                <td id="aP7A">0</td>
                <td id="aP7G">0</td>
                <td id="aP7Pct">0%</td>
                <td id="aTH">0</td>
                <td id="aBL">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="inner hint">Koppints a **L√∂v**, **G√≥l**, **7A**, **7G**, **TH**, **BL** cell√°ra a gyors +1-hez. A pipa jelzi a nevez√©st.</div>
      </div>

      <!-- CSAPAT B -->
      <div class="card" id="teamBCard">
        <div class="inner teamhdr">
          <div class="teamleft">
            <span class="pill">J√°t√©kos (B):
              <select id="pickerB"></select>
            </span>
            <button class="btn ok" id="thB" title="Technikai hiba +">TH +</button>
            <button class="btn" id="blB" title="Blokk +">BL +</button>
          </div>
          <div class="g">
            <button class="btn" id="lockB">N√©vjegyz√©k lez√°r</button>
            <button class="btn" id="allOnB">√ñsszes be</button>
            <button class="btn" id="allOffB">√ñsszes ki</button>
            <button class="btn" id="pasteB">Gyors keret</button>
          </div>
        </div>

        <div class="inner table-wrap">
          <table>
            <thead>
              <tr>
                <th class="left sticky-col" style="width:220px">‚úì # / N√©v (B)</th>
                <th style="width:70px">P√°lya</th>
                <th style="width:52px">L√∂v</th>
                <th style="width:52px">G√≥l</th>
                <th style="width:44px">%</th>
                <th style="width:44px">7A</th>
                <th style="width:44px">7G</th>
                <th style="width:44px">7%</th>
                <th style="width:52px">TH</th>
                <th style="width:52px">BL</th>
              </tr>
            </thead>
            <tbody id="bodyB"></tbody>
            <tfoot>
              <tr>
                <td class="left sticky-col">√ñsszesen (nevezettek)</td>
                <td id="bPlayTime">00:00</td>
                <td id="bShots">0</td>
                <td id="bGoals">0</td>
                <td id="bPct">0%</td>
                <td id="bP7A">0</td>
                <td id="bP7G">0</td>
                <td id="bP7Pct">0%</td>
                <td id="bTH">0</td>
                <td id="bBL">0</td>
              </tr>
            </tfoot>
          </table>
        </div>
        <div class="inner hint">Koppints a **L√∂v**, **G√≥l**, **7A**, **7G**, **TH**, **BL** cell√°ra a gyors +1-hez. A pipa jelzi a nevez√©st.</div>
      </div>
    </div>
  </div>

  <!-- Mentett m√©rk≈ëz√©sek modal -->
  <div class="modal" id="matchesModal">
    <div class="box">
      <div class="row">
        <strong>Mentett m√©rk≈ëz√©sek</strong>
        <span class="pill">Keres√©s: <input id="searchMatches" placeholder="d√°tum / csapat / j√°t√©kos"></span>
        <span class="g" style="margin-left:auto">
          <button class="btn" id="closeMatches">Bez√°r</button>
        </span>
      </div>
      <div class="list">
        <table id="matchesTable" style="width:100%">
          <thead><tr><th>D√°tum</th><th>M√©rk≈ëz√©s</th><th>Csapatok</th><th>M≈±velet</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
/* ====== √ÅLLAND√ìK / T√ÅROL√ìK ====== */
const MAXP = 20;
const UNDO_LIMIT = 10;

const LS_STATE   = 'hb_dual_v4_state';
const LS_MATCHES = 'hb_dual_v4_matches';
const LS_TEAMS   = 'hb_dual_v4_teams';

const $ = (id)=>document.getElementById(id);
const pct=(n,d)=> d? (Math.round((n/d*1000))/10).toFixed(1)+"%":"0%";
const formatDuration=(sec)=>{
  const total = Math.max(0, Math.floor(Number(sec)||0));
  const h=Math.floor(total/3600);
  const m=Math.floor((total%3600)/60);
  const s=total%60;
  if(h>0) return `${h}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
};

/* ====== ALAP √ÅLLAPOT ====== */
const emptyPlayer = ()=>({active:true,num:"",name:"",shots:0,goals:0,p7a:0,p7g:0,th:0,bl:0,onCourt:false,timeOnCourt:0});
const emptyTeam = ()=>({locked:false, name:"", logo:"", players:Array.from({length:MAXP}, emptyPlayer)});

const normalizePlayer = (p)=>{
  const merged = {...emptyPlayer(), ...p};
  merged.onCourt = !!merged.onCourt;
  merged.timeOnCourt = Number.isFinite(merged.timeOnCourt) ? Math.max(0, Math.floor(merged.timeOnCourt)) : 0;
  return merged;
};

let state = JSON.parse(localStorage.getItem(LS_STATE)) || {
  matchName:"", matchDate: todayStr(), currentHalf:1, remainingSeconds:30*60,
  singleTeam:false,
  A: emptyTeam(), B: emptyTeam()
};
let matches = JSON.parse(localStorage.getItem(LS_MATCHES) || '[]');
let teams   = JSON.parse(localStorage.getItem(LS_TEAMS) || '[]'); // [{name,logo,players:[{num,name}],updatedAt}]
let undoStack = []; // {side,index,field,delta,label}

/* ====== SEG√âD ====== */
function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }
function saveAll(){
  localStorage.setItem(LS_STATE, JSON.stringify(state));
  localStorage.setItem(LS_MATCHES, JSON.stringify(matches));
  localStorage.setItem(LS_TEAMS, JSON.stringify(teams));
}
function readLogo(file, cb){
  if(!file) return;
  const r=new FileReader();
  r.onload=()=> cb(r.result);
  r.readAsDataURL(file);
}
function pushUndo(side,index,field,delta,label){
  undoStack.unshift({side,index,field,delta,label});
  if(undoStack.length>UNDO_LIMIT) undoStack.pop();
  updateUndoLabel();
}
function updateUndoLabel(){
  const u = undoStack[0];
  $('undoLabel').textContent = u ? ` ${u.label}` : ' Visszavon√°s';
  $('undoBtn').disabled = !u;
}

/* ====== RENDER ====== */
function renderAll(){
  // top
  $('matchName').value = state.matchName||"";
  $('matchDate').value = state.matchDate||todayStr();
  $('halfLabel').textContent = state.currentHalf===1 ? "1." : "2.";
  $('singleTeamToggle').checked = !!state.singleTeam;
  updateClock();

  // names & logos
  $('teamAName').value = state.A.name||"";
  $('teamBName').value = state.B.name||"";
  $('logoA').src = state.A.logo || "";
  $('logoB').src = state.B.logo || "";

  // single team UI
  document.getElementById('teamBHeader').style.display = state.singleTeam ? 'none' : '';
  document.getElementById('teamBCard').style.display   = state.singleTeam ? 'none' : '';

  renderTeam('A'); renderTeam('B');
  populateTeamSelectors();
  updateScore();
  updateUndoLabel();
}

/* ====== CSAPAT RENDER ====== */
function totals(team){
  const on = team.players.filter(p=>p.active);
  const shots=on.reduce((a,p)=>a+p.shots,0);
  const goals=on.reduce((a,p)=>a+p.goals,0);
  const p7a  =on.reduce((a,p)=>a+p.p7a,0);
  const p7g  =on.reduce((a,p)=>a+p.p7g,0);
  const th   =on.reduce((a,p)=>a+p.th,0);
  const bl   =on.reduce((a,p)=>a+p.bl,0);
  const playTime = on.reduce((a,p)=>a+(p.timeOnCourt||0),0);
  return {shots,goals,p7a,p7g,th,bl,playTime};
}
function addCellTD(val, onPlus){
  const td=document.createElement('td'); td.textContent=val; td.style.cursor='pointer'; td.title='+1';
  td.addEventListener('click', onPlus);
  return td;
}
function renderTeam(side){
  const team = state[side];
  const body = side==='A' ? $('bodyA') : $('bodyB');
  body.innerHTML="";

  team.players.forEach((p,i)=>{
    const player = normalizePlayer(p);
    team.players[i] = player;
    const tr=document.createElement('tr');
    if(!player.active) tr.classList.add('inactive');

    // first col: checkbox + # + name
    const td=document.createElement('td'); td.className='left sticky-col';
    if(team.locked){
      td.innerHTML = `
        <div class="namecell">
          <input type="checkbox" class="enroll" ${player.active?'checked':''} data-side="${side}" data-i="${i}">
          <span style="width:2.6rem;display:inline-block;text-align:center;">${player.num||""}</span>
          <span style="flex:1;min-width:80px;overflow:hidden;text-overflow:ellipsis">${player.name||""}</span>
        </div>`;
      td.querySelector('.enroll').addEventListener('change',(e)=>{
        player.active=e.target.checked; updateScore(); saveAll(); renderTeam(side);
      });
    }else{
      const wrap=document.createElement('div'); wrap.className='namecell';
      const chk=document.createElement('input'); chk.type='checkbox'; chk.className='enroll'; chk.checked=player.active;
      chk.addEventListener('change',()=>{ player.active=chk.checked; updateScore(); saveAll(); renderTeam(side); });
      const num=document.createElement('input'); num.className='num'; num.placeholder='#'; num.value=player.num;
      const name=document.createElement('input'); name.className='name'; name.placeholder='N√©v'; name.value=player.name;
      num.addEventListener('input',()=>{ player.num=num.value; populatePicker(side); saveAll(); });
      name.addEventListener('input',()=>{ player.name=name.value; populatePicker(side); saveAll(); });
      wrap.append(chk,num,name); td.appendChild(wrap);
    }
    tr.appendChild(td);

    const playTd=document.createElement('td'); playTd.className='playcell';
    const playBtn=document.createElement('button');
    playBtn.type='button';
    playBtn.className='play-toggle'+(player.onCourt?' on':'');
    playBtn.textContent=player.onCourt?'‚¨§':'‚óã';
    playBtn.title = player.onCourt ? 'Le a p√°ly√°r√≥l' : 'P√°ly√°ra l√©p';
    playBtn.setAttribute('aria-pressed', player.onCourt ? 'true' : 'false');
    playBtn.setAttribute('aria-label', player.onCourt ? 'Le a p√°ly√°r√≥l' : 'P√°ly√°ra l√©p');
    playBtn.addEventListener('click',()=>{ toggleOnCourt(side,i); });
    const timeSpan=document.createElement('div');
    timeSpan.className='playtime';
    timeSpan.id=`time_${side}_${i}`;
    timeSpan.textContent=formatDuration(player.timeOnCourt);
    playTd.append(playBtn,timeSpan);
    tr.appendChild(playTd);

    const addAndRerender = (fn)=>()=>{ fn(); renderTeam(side); updateScore(); saveAll(); };

    tr.appendChild(addCellTD(player.shots, addAndRerender(()=>{ player.shots++; pushUndo(side,i,'shots',-1,`L√∂v√©s: ${side} #${player.num||i+1} ${player.name||''}`); })));
    tr.appendChild(addCellTD(player.goals, addAndRerender(()=>{ player.goals++; player.shots++; pushUndo(side,i,'combo_goal',-1,`G√≥l: ${side} #${player.num||i+1} ${player.name||''}`); })));
    const tdPct=document.createElement('td'); tdPct.textContent=pct(player.goals,player.shots); tr.appendChild(tdPct);
    tr.appendChild(addCellTD(player.p7a,  addAndRerender(()=>{ player.p7a++; player.shots++; pushUndo(side,i,'combo_7a',-1,`7A: ${side} #${player.num||i+1} ${player.name||''}`); })));
    tr.appendChild(addCellTD(player.p7g,  addAndRerender(()=>{ player.p7g++; player.p7a++; player.shots++; player.goals++; pushUndo(side,i,'combo_7g',-1,`7G: ${side} #${player.num||i+1} ${player.name||''}`); })));
    const td7p=document.createElement('td'); td7p.textContent=pct(player.p7g,player.p7a); tr.appendChild(td7p);
    tr.appendChild(addCellTD(player.th,   addAndRerender(()=>{ player.th++; pushUndo(side,i,'th',-1,`TH: ${side} #${player.num||i+1} ${player.name||''}`); })));
    tr.appendChild(addCellTD(player.bl,   addAndRerender(()=>{ player.bl++; pushUndo(side,i,'bl',-1,`BL: ${side} #${player.num||i+1} ${player.name||''}`); })));

    body.appendChild(tr);
  });

  // totals
  const t=totals(team);
  (side==='A'?$('aPlayTime'):$('bPlayTime')).textContent=formatDuration(t.playTime);
  (side==='A'?$('aShots'):$('bShots')).textContent=t.shots;
  (side==='A'?$('aGoals'):$('bGoals')).textContent=t.goals;
  (side==='A'?$('aPct')  :$('bPct')).textContent=pct(t.goals,t.shots);
  (side==='A'?$('aP7A')  :$('bP7A')).textContent=t.p7a;
  (side==='A'?$('aP7G')  :$('bP7G')).textContent=t.p7g;
  (side==='A'?$('aP7Pct'):$('bP7Pct')).textContent=pct(t.p7g,t.p7a);
  (side==='A'?$('aTH')   :$('bTH')).textContent=t.th;
  (side==='A'?$('aBL')   :$('bBL')).textContent=t.bl;

  populatePicker(side);
  (side==='A'?$('lockA'):$('lockB')).textContent = team.locked ? 'N√©vjegyz√©k felold' : 'N√©vjegyz√©k lez√°r';
}

function toggleOnCourt(side,index){
  const team = state[side];
  const player = team.players[index];
  if(!player) return;
  player.onCourt = !player.onCourt;
  saveAll();
  renderTeam(side);
}

/* ====== PICKEREK & SELECT ALL ====== */
function populatePicker(side){
  const team=state[side]; const pick=side==='A'?$('pickerA'):$('pickerB'); const sel=pick.value;
  pick.innerHTML="";
  team.players.forEach((p,i)=>{
    const o=document.createElement('option');
    o.value=String(i);
    o.textContent=`${p.num||i+1} ‚Äì ${p.name||("J√°t√©kos "+(i+1))}`;
    pick.appendChild(o);
  });
  if(sel) pick.value=sel;
}
$('allOnA').addEventListener('click',()=>{ state.A.players.forEach(p=>p.active=true); renderTeam('A'); updateScore(); saveAll(); });
$('allOffA').addEventListener('click',()=>{ state.A.players.forEach(p=>p.active=false); renderTeam('A'); updateScore(); saveAll(); });
$('allOnB').addEventListener('click',()=>{ state.B.players.forEach(p=>p.active=true); renderTeam('B'); updateScore(); saveAll(); });
$('allOffB').addEventListener('click',()=>{ state.B.players.forEach(p=>p.active=false); renderTeam('B'); updateScore(); saveAll(); });

/* ====== SCORE ====== */
function updateScore(){
  const a=totals(state.A).goals;
  const b= state.singleTeam ? 0 : totals(state.B).goals;
  $('scoreBoard').textContent=`${a} : ${b}`;
}

function incrementOnCourt(sec){
  ['A','B'].forEach(side=>{
    const team=state[side];
    let total=0;
    team.players.forEach((p,i)=>{
      if(p.onCourt){
        p.timeOnCourt = Math.max(0, (p.timeOnCourt||0) + sec);
        const span=document.getElementById(`time_${side}_${i}`);
        if(span) span.textContent=formatDuration(p.timeOnCourt);
      }
      if(p.active) total += p.timeOnCourt||0;
    });
    const totalCell = side==='A'?$('aPlayTime'):$('bPlayTime');
    if(totalCell) totalCell.textContent = formatDuration(total);
  });
}

/* ====== √ìRA + HOSSZABB√çT√ÅS ====== */
let tmr=null;
function updateClock(){
  const m=Math.floor(state.remainingSeconds/60), s=state.remainingSeconds%60;
  $('clock').textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function tickClock(){
  if(state.remainingSeconds<=0){
    pause();
    alert((state.currentHalf===1?"1.":"2.")+" f√©lid≈ë v√©ge");
    return;
  }
  state.remainingSeconds=Math.max(0,state.remainingSeconds-1);
  incrementOnCourt(1);
  updateClock();
  saveAll();
  if(state.remainingSeconds===0){
    pause();
    alert((state.currentHalf===1?"1.":"2.")+" f√©lid≈ë v√©ge");
  }
}
function start(){ if(tmr || state.remainingSeconds<=0) return; tmr=setInterval(tickClock,1000); }
function pause(){ if(!tmr) return; clearInterval(tmr); tmr=null; }
function reset30(){ pause(); state.remainingSeconds=30*60; updateClock(); saveAll(); }
function addExtra(sec){ state.remainingSeconds += sec; if(state.remainingSeconds<0) state.remainingSeconds=0; updateClock(); saveAll(); }
function switchHalf(){ pause(); state.currentHalf=state.currentHalf===1?2:1; reset30(); renderAll(); }

/* ====== INPUTOK / GOMBOK ====== */
$('matchName').addEventListener('input', e=>{ state.matchName=e.target.value; saveAll(); });
$('matchDate').value = state.matchDate || todayStr();
$('matchDate').addEventListener('input', e=>{ state.matchDate=e.target.value; saveAll(); });
$('teamAName').addEventListener('input', e=>{ state.A.name=e.target.value; saveAll(); });
$('teamBName').addEventListener('input', e=>{ state.B.name=e.target.value; saveAll(); });
$('logoAInput').addEventListener('change', e=> readLogo(e.target.files?.[0], data=>{ state.A.logo=data; $('logoA').src=data; saveAll(); }));
$('logoBInput').addEventListener('change', e=> readLogo(e.target.files?.[0], data=>{ state.B.logo=data; $('logoB').src=data; saveAll(); }));

$('startBtn').addEventListener('click', start);
$('pauseBtn').addEventListener('click', pause);
$('resetClockBtn').addEventListener('click', reset30);
$('switchHalfBtn').addEventListener('click', switchHalf);
document.querySelectorAll('[data-et]').forEach(b=> b.addEventListener('click', ()=> addExtra(parseInt(b.getAttribute('data-et'),10))));
$('etCustom').addEventListener('click', ()=>{ const mm=prompt("H√°ny percet adjak hozz√°? (perc)"); if(mm===null) return; const m=parseInt(mm,10); if(!isNaN(m)) addExtra(m*60); });

$('singleTeamToggle').addEventListener('change', (e)=>{ state.singleTeam = e.target.checked; renderAll(); saveAll(); });

/* TH/BL gyorsgombok (a kiv√°lasztott j√°t√©kosra) */
$('thA').addEventListener('click', ()=>{ const i=parseInt($('pickerA').value,10); const p=state.A.players[i]; p.th++; pushUndo('A',i,'th',-1,`TH: A #${p.num||i+1} ${p.name||''}`); renderTeam('A'); updateScore(); saveAll(); });
$('blA').addEventListener('click', ()=>{ const i=parseInt($('pickerA').value,10); const p=state.A.players[i]; p.bl++; pushUndo('A',i,'bl',-1,`BL: A #${p.num||i+1} ${p.name||''}`); renderTeam('A'); updateScore(); saveAll(); });
$('thB').addEventListener('click', ()=>{ const i=parseInt($('pickerB').value,10); const p=state.B.players[i]; p.th++; pushUndo('B',i,'th',-1,`TH: B #${p.num||i+1} ${p.name||''}`); renderTeam('B'); updateScore(); saveAll(); });
$('blB').addEventListener('click', ()=>{ const i=parseInt($('pickerB').value,10); const p=state.B.players[i]; p.bl++; pushUndo('B',i,'bl',-1,`BL: B #${p.num||i+1} ${p.name||''}`); renderTeam('B'); updateScore(); saveAll(); });

/* Lock/keret beilleszt√©s */
$('lockA').addEventListener('click', ()=>{ state.A.locked=!state.A.locked; renderTeam('A'); saveAll(); });
$('lockB').addEventListener('click', ()=>{ state.B.locked=!state.B.locked; renderTeam('B'); saveAll(); });

$('pasteA').addEventListener('click', ()=>{
  const txt=prompt("CSAPAT A ‚Äì Illeszd be max. 20 sort (mezsz√°m sz√≥k√∂z N√©v)"); if(!txt) return;
  txt.split(/\r?\n/).slice(0,MAXP).forEach((ln,i)=>{ const m=ln.trim().match(/^(\d+)\s+(.*)$/); if(m){ state.A.players[i].num=m[1]; state.A.players[i].name=m[2]; } else { state.A.players[i].name=ln.trim(); state.A.players[i].num=String(i+1);} });
  renderTeam('A'); saveAll();
});
$('pasteB').addEventListener('click', ()=>{
  const txt=prompt("CSAPAT B ‚Äì Illeszd be max. 20 sort (mezsz√°m sz√≥k√∂z N√©v)"); if(!txt) return;
  txt.split(/\r?\n/).slice(0,MAXP).forEach((ln,i)=>{ const m=ln.trim().match(/^(\d+)\s+(.*)$/); if(m){ state.B.players[i].num=m[1]; state.B.players[i].name=m[2]; } else { state.B.players[i].name=ln.trim(); state.B.players[i].num=String(i+1);} });
  renderTeam('B'); saveAll();
});

/* ====== MENTETT CSAPATOK ====== */
function populateTeamSelectors(){
  const selA=$('loadTeamA'), selB=$('loadTeamB');
  const names=[...new Set(teams.map(t=>t.name))].sort();
  [selA,selB].forEach(sel=>{ sel.innerHTML=""; names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); });
}
function saveTeam(side){
  const t = state[side];
  if(!t.name){ alert("El≈ëbb adj nevet a csapatnak."); return; }
  const entry={ name:t.name, logo:t.logo||"", players:t.players.map(p=>({num:p.num,name:p.name})), updatedAt: Date.now() };
  const idx=teams.findIndex(x=>x.name===t.name);
  if(idx>=0) teams[idx]=entry; else teams.push(entry);
  saveAll(); populateTeamSelectors(); alert("Csapat mentve.");
}
function loadTeam(side, name){
  const e=teams.find(x=>x.name===name); if(!e){ alert("Nincs ilyen mentett csapat."); return; }
  const dest=state[side];
  dest.name=e.name; dest.logo=e.logo||"";
  e.players.slice(0,MAXP).forEach((pl,i)=>{ dest.players[i].num=pl.num||""; dest.players[i].name=pl.name||""; });
  renderAll(); saveAll();
}
$('saveTeamABtn').addEventListener('click', ()=> saveTeam('A'));
$('saveTeamBBtn').addEventListener('click', ()=> saveTeam('B'));
$('loadTeamABtn').addEventListener('click', ()=>{ const n=$('loadTeamA').value; if(n) loadTeam('A',n); });
$('loadTeamBBtn').addEventListener('click', ()=>{ const n=$('loadTeamB').value; if(n) loadTeam('B',n); });

/* ====== MENTETT MECCSEK ====== */
$('saveMatchBtn').addEventListener('click', ()=>{
  const id = Date.now();
  const title = (state.matchName||"N√©vtelen meccs");
  const entry = {
    id, date: state.matchDate||todayStr(), title,
    teamA: state.A.name||"A", teamB: state.B.name||"B",
    snapshot: JSON.parse(JSON.stringify(state))
  };
  matches.unshift(entry);
  saveAll();
  alert("M√©rk≈ëz√©s elmentve.");
});
$('openMatchesBtn').addEventListener('click', ()=>{ refreshMatchesList(); $('matchesModal').style.display='flex'; });
$('closeMatches').addEventListener('click', ()=>{ $('matchesModal').style.display='none'; });

function refreshMatchesList(filter=""){
  const tb = $('matchesTable').querySelector('tbody');
  tb.innerHTML="";
  const norm = (s)=> (s||"").toString().toLowerCase();
  const rows = matches.filter(m=>{
    const hay = [m.date,m.title,m.teamA,m.teamB, JSON.stringify(m.snapshot)].join(" ").toLowerCase();
    return hay.includes(norm(filter));
  });
  rows.forEach(m=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${m.date}</td>
      <td>${m.title}</td>
      <td>${m.teamA} ‚Äì ${m.teamB}</td>
      <td>
        <button class="btn" data-act="load" data-id="${m.id}">Bet√∂lt</button>
        <button class="btn dan" data-act="del" data-id="${m.id}">T√∂rl√©s</button>
      </td>`;
    tb.appendChild(tr);
  });
}
$('searchMatches').addEventListener('input', e=> refreshMatchesList(e.target.value));
$('matchesTable').addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  const id=Number(b.getAttribute('data-id'));
  const idx=matches.findIndex(x=>x.id===id); if(idx<0) return;
  if(b.getAttribute('data-act')==='del'){
    if(confirm("Biztosan t√∂rl√∂d ezt a ment√©st?")){ matches.splice(idx,1); saveAll(); refreshMatchesList($('searchMatches').value); }
  }else{
    state = JSON.parse(JSON.stringify(matches[idx].snapshot));
    saveAll(); renderAll(); $('matchesModal').style.display='none';
  }
});

/* ====== EXPORT: EXCEL / PDF ====== */
function teamRowsForExport(team){
  return team.players.filter(p=>p.active).map(p=>[
    p.num,
    p.name,
    formatDuration(p.timeOnCourt||0),
    p.shots,
    p.goals,
    pct(p.goals,p.shots),
    p.p7a,
    p.p7g,
    pct(p.p7g,p.p7a),
    p.th,
    p.bl
  ]);
}
function exportExcel(){
  const header = ["#", "N√©v", "P√°lya", "L√∂v", "G√≥l", "%", "7A", "7G", "7%", "TH", "BL"];
  const wsData = [];

  wsData.push([state.matchName||"", "", "", "", "", "", "", "", "", "", ""]);
  wsData.push([state.matchDate||todayStr(), "", "", "", "", "", "", "", "", "", ""]);
  wsData.push([]);

  // A blokk
  wsData.push(["CSAPAT A: "+(state.A.name||"")]); wsData.push(header);
  const rowsA = teamRowsForExport(state.A);
  rowsA.forEach(r=> wsData.push(r));

  const offset = 12;
  // B blokk ‚Äì csak ha nincs singleTeam m√≥dban
  if(!state.singleTeam){
    const startRow = 3;
    if(!wsData[startRow]) wsData[startRow]=[];
    wsData[startRow][offset] = "CSAPAT B: "+(state.B.name||"");
    if(!wsData[startRow+1]) wsData[startRow+1]=[];
    header.forEach((h,i)=> wsData[startRow+1][offset+i] = h);
    const rowsB = teamRowsForExport(state.B);
    rowsB.forEach((r,ri)=>{
      if(!wsData[startRow+2+ri]) wsData[startRow+2+ri]=[];
      r.forEach((val,ci)=> wsData[startRow+2+ri][offset+ci] = val);
    });
  }

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Statisztika");
  const fname = `kezilabda_${(state.matchDate||todayStr())}.xlsx`;
  XLSX.writeFile(wb, fname);
}
function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({orientation:'landscape', unit:'mm', format:'a4'});
  const title = state.matchName||"K√©zilabda m√©rk≈ëz√©s";
  const date  = state.matchDate||todayStr();
  doc.setFontSize(14);
  doc.text(`${title}  (${date})`, 10, 10);

  const head = [["#", "N√©v", "P√°lya", "L√∂v", "G√≥l", "%", "7A", "7G", "7%", "TH", "BL"]];
  const rowsA = teamRowsForExport(state.A);

  // Bal t√°bl√°zat (A)
  doc.autoTable({
    head, body: rowsA,
    startY: 16, margin:{left:10}, tableWidth: 130,
    styles:{ fontSize:8 }
  });

  if(!state.singleTeam){
    const rowsB = teamRowsForExport(state.B);
    // Jobb t√°bl√°zat (B)
    doc.autoTable({
      head, body: rowsB,
      startY: 16, margin:{left:160}, tableWidth: 130,
      styles:{ fontSize:8 }
    });
  }

  doc.save(`kezilabda_${date}.pdf`);
}

/* ====== BACKUP / RESTORE (JSON) ====== */
$('backupBtn').addEventListener('click', ()=>{
  const all={ state, matches, teams, exportedAt: new Date().toISOString() };
  const blob=new Blob([JSON.stringify(all,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kezilabda_backup.json';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
});
$('restoreBtn').addEventListener('click', ()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      try{
        const obj=JSON.parse(r.result);
        if(obj.state) state=obj.state;
        if(obj.matches) matches=obj.matches;
        if(obj.teams) teams=obj.teams;
        saveAll(); renderAll();
        alert("Vissza√°ll√≠tva.");
      }catch(_){ alert("Hib√°s JSON."); }
    };
    r.readAsText(f);
  };
  inp.click();
});

/* ====== UNDO / RESET ====== */
$('undoBtn').addEventListener('click', ()=>{
  const u = undoStack.shift(); // legutols√≥
  if(!u) return;
  const team = state[u.side];
  const p = team.players[u.index];
  // visszavonjuk a kombin√°lt l√©p√©seket is
  if(u.field==='combo_goal'){ p.goals=Math.max(0,p.goals+u.delta); p.shots=Math.max(0,p.shots+u.delta); }
  else if(u.field==='combo_7a'){ p.p7a=Math.max(0,p.p7a+u.delta); p.shots=Math.max(0,p.shots+u.delta); }
  else if(u.field==='combo_7g'){ p.p7g=Math.max(0,p.p7g+u.delta); p.p7a=Math.max(0,p.p7a+u.delta); p.shots=Math.max(0,p.shots+u.delta); p.goals=Math.max(0,p.goals+u.delta); }
  else if(u.field in p){ p[u.field]=Math.max(0, p[u.field] + u.delta); }
  renderTeam(u.side); updateScore(); saveAll(); updateUndoLabel();
});

$('hardResetBtn').addEventListener('click', ()=>{
  if(!confirm("Biztosan t√∂rl√∂d a statokat erre a m√©rk≈ëz√©sre? (Nevez√©sek √©s nevek megmaradnak)")) return;
  ['A','B'].forEach(side=>{
    state[side].players.forEach(p=>{
      p.shots=0; p.goals=0; p.p7a=0; p.p7g=0; p.th=0; p.bl=0;
      p.timeOnCourt=0; p.onCourt=false;
    });
  });
  undoStack = [];
  renderAll(); saveAll();
});

/* ====== EXPORT GOMBOK ====== */
$('exportExcelBtn').addEventListener('click', exportExcel);
$('exportPdfBtn').addEventListener('click', exportPDF);

/* ====== S≈∞R≈∞S√âG ====== */
$('densitySel').addEventListener('change', (e)=>{
  document.body.classList.remove('density-cozy','density-compact','density-ultra');
  document.body.classList.add(e.target.value);
});

/* ====== AUTO MENT√âS ====== */
setInterval(()=> saveAll(), 30000);

/* ====== INIT ====== */
function init(){
  ['A','B'].forEach(side=>{
    const t=state[side];
    t.players = (t.players||[]).slice(0,MAXP).map(normalizePlayer);
    while(t.players.length<MAXP) t.players.push(emptyPlayer());
  });
  renderAll();
  saveAll();
}
function populateTeamSelectors(){
  const selA=$('loadTeamA'), selB=$('loadTeamB');
  const names=[...new Set(teams.map(t=>t.name))].sort();
  [selA,selB].forEach(sel=>{ sel.innerHTML=""; names.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); }); });
}
init();
</script>

</body>
</html>
