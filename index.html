<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kézilabda statisztika – Dual Pro (PWA)</title>

<!-- PWA meta -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#2d6cdf">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Kézi Stat">

<style>
  :root{
    --bg:#0b0c0f; --panel:#11141a; --card:#151923; --muted:#9aa2b1; --text:#eef2f7;
    --accent:#5b8cfa; --accent2:#22c55e; --warn:#f59e0b; --danger:#ef4444; --border:#232838; --chip:#1b2230;
    --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  .light{
    --bg:#f6f7fb; --panel:#ffffff; --card:#ffffff; --muted:#5e6573; --text:#0b1220;
    --accent:#2d6cdf; --accent2:#16a34a; --warn:#d97706; --danger:#dc2626; --border:#e8eaf0; --chip:#f2f5fb;
    --shadow: 0 10px 30px rgba(21,28,43,.08);
    color-scheme: light;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; background:var(--bg); color:var(--text); font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}

  .topbar{ position:sticky; top:0; z-index:50; backdrop-filter: blur(10px);
           background: color-mix(in oklab, var(--panel) 82%, transparent);
           border-bottom:1px solid var(--border); box-shadow:var(--shadow); }
  .topbar .wrap{ max-width:1200px; margin:0 auto; padding:10px 14px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between; }
  .brand{ display:flex; gap:10px; align-items:center; }
  .logo{ width:28px; height:28px; border-radius:8px; background:linear-gradient(135deg,var(--accent),var(--accent2)); box-shadow:var(--shadow); }
  .brand h1{ font-size:16px; margin:0; font-weight:800; letter-spacing:.2px }

  .controls{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
  .pill{ display:flex; gap:8px; align-items:center; padding:8px 10px; border:1px solid var(--border); background:var(--chip); border-radius:999px; }
  .pill input{ border:0; background:transparent; outline:none; color:var(--text); min-width:190px; }
  .timer{ font-variant-numeric: tabular-nums; font-size:22px; font-weight:800; letter-spacing:.5px; padding:8px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card); }
  .half{ font-weight:700; }
  button{ border:1px solid var(--border); background:var(--card); color:var(--text); border-radius:10px; padding:9px 12px; cursor:pointer; transition: transform .04s ease, opacity .2s ease;}
  button:active{ transform: translateY(1px) }
  button.primary{ background:var(--accent); color:#fff; }
  button.success{ background:var(--accent2); color:#fff; }
  button.warn{ background:var(--warn); color:#fff; }
  button.danger{ background:var(--danger); color:#fff; }
  button.ghost{ background:var(--chip); }
  .btn-group{ display:flex; gap:8px; flex-wrap:wrap; }

  .container{ max-width:1200px; margin:16px auto; padding:0 14px; display:grid; gap:14px; }
  .grid{ display:grid; grid-template-columns: 1fr; gap:14px; }
  @media (min-width: 980px){ .grid{ grid-template-columns: 1fr 1fr; } }
  .card{ border:1px solid var(--border); border-radius:14px; background:var(--card); box-shadow:var(--shadow); }
  .card .inner{ padding:14px; }
  .chip{ padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); background:var(--chip); color:var(--muted); }
  .hint{ color:var(--muted); font-size:13px; }
  .team-header{ display:flex; align-items:center; gap:10px; justify-content:space-between; margin-bottom:8px; }
  .team-title{ display:flex; align-items:center; gap:10px; }
  .crest{ width:36px; height:36px; border-radius:6px; border:1px solid var(--border); background:var(--panel); object-fit:cover; }
  .uploader{ display:flex; align-items:center; gap:8px; }

  .scorebar{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; justify-content:center; }
  .score{ font-size:28px; font-weight:900; padding:6px 12px; border-radius:12px; border:1px solid var(--border); background:var(--panel); font-variant-numeric: tabular-nums; }

  .table-wrap{ overflow:auto; border-radius:12px; border:1px solid var(--border); }
  table{ width:100%; border-collapse:collapse; font-size:14px; }
  thead th{ position:sticky; top:0; background:color-mix(in oklab, var(--panel) 94%, black 0%); border-bottom:1px solid var(--border); padding:10px 8px; text-align:center; font-weight:700; }
  tbody td{ border-bottom:1px solid var(--border); padding:8px; text-align:center; }
  td.left, th.left { text-align:left; }
  tr:hover td{ background: color-mix(in oklab, var(--card) 85%, white 0%); }
  tfoot td{ padding:10px 8px; font-weight:700; background: color-mix(in oklab, var(--panel) 92%, black 0%); }
  .namecell{ display:flex; gap:8px; align-items:center; }
  .num{ width:3.6rem; text-align:center; padding:7px 8px; border:1px solid var(--border); border-radius:9px; background:var(--panel); color:var(--text); }
  .name{ flex:1; min-width:160px; padding:7px 10px; border:1px solid var(--border); border-radius:9px; background:var(--panel); color:var(--text); }

  .footerbar{ position:sticky; bottom:0; z-index:40; display:flex; justify-content:center; padding:10px; background:linear-gradient(180deg, transparent, color-mix(in oklab, var(--panel) 92%, black)); }
  .kbd{ font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px; padding:2px 6px; border-radius:6px; border:1px solid var(--border); background:var(--chip); color:var(--muted); }
  .spacer{ flex:1 }

  @media print{
    body{ background:#fff; color:#000; }
    .topbar,.footerbar, .hint, .btn-group, #themeBtn{ display:none !important; }
    .container{ max-width:none; margin:0; padding:0; }
    .card{ box-shadow:none; border:0; }
    .table-wrap{ border:1px solid #ddd; }
    .crest{ border:1px solid #ddd; }
  }
</style>
</head>
<body class="light" id="body">
  <div class="topbar">
    <div class="wrap">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>Kézilabda statisztika – Dual Pro</h1>
      </div>
      <div class="controls">
        <span class="pill">Mérkőzés: <input id="matchName" type="text" placeholder="Pl. Veszprém – Szeged, NB I."></span>
        <span class="pill half">Félidő: <span id="halfLabel" style="margin-left:6px">1. félidő</span></span>
        <span class="timer" id="clock">30:00</span>
        <div class="btn-group">
          <button id="startBtn" class="primary">Indít</button>
          <button id="pauseBtn" class="ghost">Szünet</button>
          <button id="resetClockBtn" class="ghost">Óra nulláz</button>
          <button id="switchHalfBtn" class="warn">Félidő váltás</button>
        </div>
        <div class="btn-group">
          <button id="undoBtn" title="Ctrl/Cmd+Z">Visszavonás</button>
          <button id="redoBtn" title="Ctrl/Cmd+Y">Újra</button>
          <button id="exportBtn">Export CSV</button>
          <button id="saveBtn">Mentés (JSON)</button>
          <button id="loadBtn">Betöltés</button>
          <button id="pdfBtn">Export PDF</button>
          <button id="themeBtn">Sötét / Világos</button>
          <button id="clearBtn" class="danger">Új meccs</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="inner scorebar">
        <div class="team-title">
          <img id="crestA" class="crest" alt="A csapat logó">
          <span class="pill">A csapat: <input id="teamAName" type="text" placeholder="Csapat A"></span>
          <label class="uploader"><input id="logoAInput" type="file" accept="image/*"> Logó feltöltés</label>
        </div>
        <div class="score" id="scoreBoard">0 : 0</div>
        <div class="team-title">
          <img id="crestB" class="crest" alt="B csapat logó">
          <span class="pill">B csapat: <input id="teamBName" type="text" placeholder="Csapat B"></span>
          <label class="uploader"><input id="logoBInput" type="file" accept="image/*"> Logó feltöltés</label>
        </div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="inner">
          <div class="team-header">
            <div class="chip">Csapat A játékos-statisztika</div>
            <button id="fillA" class="ghost">Sablon 1–16</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="left"># / Játékos</th>
                  <th>H1 Gól</th><th>H1 Véd.</th><th>H1 7m gól</th><th>H1 7m kih.</th>
                  <th>H2 Gól</th><th>H2 Véd.</th><th>H2 7m gól</th><th>H2 7m kih.</th>
                  <th>Össz. lövés</th><th>Össz. gól</th><th>Össz. véd.</th><th>7m%</th><th>Gól%</th>
                  <th>Akciók</th>
                </tr>
              </thead>
              <tbody id="bodyA"></tbody>
              <tfoot>
                <tr>
                  <td class="left">Összesen</td>
                  <td id="aH1G">0</td><td id="aH1S">0</td><td id="aH1P">0</td><td id="aH1PM">0</td>
                  <td id="aH2G">0</td><td id="aH2S">0</td><td id="aH2P">0</td><td id="aH2PM">0</td>
                  <td id="aShots">0</td><td id="aGoals">0</td><td id="aSaves">0</td>
                  <td id="a7mPct">0%</td><td id="aPct">0%</td><td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="inner" style="padding-top:10px">
            <div class="chip">Kapus-statisztika (A): Védés, Kapott gól, 7m védés, Védési %</div>
            <div class="btn-group" style="margin-top:8px">
              <button id="aGKsave" class="success">Védés +</button>
              <button id="aGKgoal" class="ghost">Kapott gól +</button>
              <button id="aGKp7" class="ghost">7m védés +</button>
              <button id="aGKminusS">Védés –</button>
              <button id="aGKminusG">Kapott –</button>
              <button id="aGKminusP">7m véd. –</button>
            </div>
            <div class="hint" id="aGKshow">Védés: 0 • Kapott: 0 • 7m védés: 0 • Védési%: 0.0%</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="inner">
          <div class="team-header">
            <div class="chip">Csapat B játékos-statisztika</div>
            <button id="fillB" class="ghost">Sablon 1–16</button>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th class="left"># / Játékos</th>
                  <th>H1 Gól</th><th>H1 Véd.</th><th>H1 7m gól</th><th>H1 7m kih.</th>
                  <th>H2 Gól</th><th>H2 Véd.</th><th>H2 7m gól</th><th>H2 7m kih.</th>
                  <th>Össz. lövés</th><th>Össz. gól</th><th>Össz. véd.</th><th>7m%</th><th>Gól%</th>
                  <th>Akciók</th>
                </tr>
              </thead>
              <tbody id="bodyB"></tbody>
              <tfoot>
                <tr>
                  <td class="left">Összesen</td>
                  <td id="bH1G">0</td><td id="bH1S">0</td><td id="bH1P">0</td><td id="bH1PM">0</td>
                  <td id="bH2G">0</td><td id="bH2S">0</td><td id="bH2P">0</td><td id="bH2PM">0</td>
                  <td id="bShots">0</td><td id="bGoals">0</td><td id="bSaves">0</td>
                  <td id="b7mPct">0%</td><td id="bPct">0%</td><td></td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="inner" style="padding-top:10px">
            <div class="chip">Kapus-statisztika (B): Védés, Kapott gól, 7m védés, Védési %</div>
            <div class="btn-group" style="margin-top:8px">
              <button id="bGKsave" class="success">Védés +</button>
              <button id="bGKgoal" class="ghost">Kapott gól +</button>
              <button id="bGKp7" class="ghost">7m védés +</button>
              <button id="bGKminusS">Védés –</button>
              <button id="bGKminusG">Kapott –</button>
              <button id="bGKminusP">7m véd. –</button>
            </div>
            <div class="hint" id="bGKshow">Védés: 0 • Kapott: 0 • 7m védés: 0 • Védési%: 0.0%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="inner hint">
        Tipp: soronként <b>Gól +</b>, <b>Kapus véd. +</b>, <b>7m gól +</b>, <b>7m kih. +</b>. A <b>–</b> gombokkal javíthatsz.
        Gyorsbillentyűk: <span class="kbd">Space</span> indít/szünet • <span class="kbd">H</span> félidő • <span class="kbd">Z</span> visszavonás • <span class="kbd">Y</span> újra.
      </div>
    </div>
  </div>

  <div class="footerbar">
    <div class="btn-group">
      <button id="quickGoal" class="success" title="Gyors gól az utolsó kijelölt játékosnak">Gyors Gól</button>
      <button id="quickSave" class="ghost"  title="Gyors védés az utolsó kijelölt játékosnak">Gyors Védés</button>
      <button id="quickP7" class="ghost"   title="Gyors 7m gól">Gyors 7m gól</button>
      <button id="quickPM" class="ghost"   title="Gyors 7m kihagyott">Gyors 7m kih.</button>
    </div>
    <span class="spacer"></span>
  </div>

<script>
// --- Service worker regisztráció ---
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js');
  });
}

/* ===== Alap állapot ===== */
const MAX_PLAYERS=16;
let currentHalf=1;
let lastFocus={team:'A', idx:0};

const app = {
  match:"",
  teamA:{ name:"", logo:"", gk:{saves:0, goalsAgainst:0, p7:0}, players:[] },
  teamB:{ name:"", logo:"", gk:{saves:0, goalsAgainst:0, p7:0}, players:[] },
  remainingSeconds: 30*60,
  undo:[], redo:[]
};

function defaultPlayer(){ return {num:"", name:"", h1:{g:0,s:0,p:0,pm:0}, h2:{g:0,s:0,p:0,pm:0}}; }
function ensurePlayers(team){
  while(team.players.length < MAX_PLAYERS) team.players.push(defaultPlayer());
}
ensurePlayers(app.teamA); ensurePlayers(app.teamB);

const $=(id)=>document.getElementById(id);
const pct=(n,d)=> d? (Math.round((n/d*1000))/10).toFixed(1)+"%":"0%";
const shotsOf=p=> p.h1.g+p.h1.s+p.h1.p+p.h1.pm + p.h2.g+p.h2.s+p.h2.p+p.h2.pm;
const goalsOf=p=> p.h1.g+p.h2.g + p.h1.p + p.h2.p;
const savesOn=p=> p.h1.s+p.h2.s;
const p7Of=p=> ({g:(p.h1.p+p.h2.p), m:(p.h1.pm+p.h2.pm)});

function teamTotals(team){
  let H1G=0,H1S=0,H1P=0,H1PM=0,H2G=0,H2S=0,H2P=0,H2PM=0;
  team.players.forEach(p=>{
    H1G+=p.h1.g; H1S+=p.h1.s; H1P+=p.h1.p; H1PM+=p.h1.pm;
    H2G+=p.h2.g; H2S+=p.h2.s; H2P+=p.h2.p; H2PM+=p.h2.pm;
  });
  const shots = H1G+H1S+H1P+H1PM+H2G+H2S+H2P+H2PM;
  const goals = H1G+H2G + H1P+H2P;
  const saves = H1S+H2S;
  const p7att = H1P+H1PM+H2P+H2PM;
  const p7g = H1P+H2P;
  return {H1G,H1S,H1P,H1PM,H2G,H2S,H2P,H2PM, shots, goals, saves, p7att, p7g,
          pct: pct(goals, shots), p7pct: pct(p7g, p7att)};
}
function updateScore(){
  const a=teamTotals(app.teamA), b=teamTotals(app.teamB);
  $('scoreBoard').textContent = `${a.goals} : ${b.goals}`;
}

function renderTeam(teamKey){
  const team = teamKey==='A'?app.teamA:app.teamB;
  const body = teamKey==='A' ? $('bodyA') : $('bodyB');
  body.innerHTML="";
  team.players.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    const tdName=document.createElement('td'); tdName.className='left';
    const wrap=document.createElement('div'); wrap.className='namecell';
    const num=document.createElement('input'); num.type='text'; num.className='num'; num.placeholder='#'; num.value=p.num;
    const name=document.createElement('input'); name.type='text'; name.className='name'; name.placeholder='Játékos neve'; name.value=p.name;
    [num,name].forEach(inp=>{ inp.addEventListener('focus', ()=>{ lastFocus={team:teamKey, idx}; }); });
    num.addEventListener('input', ()=>{ p.num=num.value; saveLocal(false); });
    name.addEventListener('input', ()=>{ p.name=name.value; saveLocal(false); });
    wrap.append(num,name); tdName.appendChild(wrap); tr.appendChild(tdName);

    const c=(t)=>{ const td=document.createElement('td'); td.textContent=t; return td; };
    tr.append(c(p.h1.g)); tr.append(c(p.h1.s)); tr.append(c(p.h1.p)); tr.append(c(p.h1.pm));
    tr.append(c(p.h2.g)); tr.append(c(p.h2.s)); tr.append(c(p.h2.p)); tr.append(c(p.h2.pm));

    const Tshots=shotsOf(p), Tgoals=goalsOf(p), Tsaves=savesOn(p), P7=p7Of(p);
    tr.append(c(Tshots)); tr.append(c(Tgoals)); tr.append(c(Tsaves));
    tr.append(c(pct(P7.g, P7.g+P7.m))); tr.append(c(pct(Tgoals, Tshots)));

    const act=document.createElement('td'); const g=document.createElement('div'); g.className='btn-group';
    const add=(lbl,cls,fn)=>{ const b=document.createElement('button'); b.textContent=lbl; if(cls) b.classList.add(cls); b.addEventListener('click', (e)=>{e.stopPropagation(); fn();}); return b; };
    g.append(
      add("Gól +","success",()=> addEvent(teamKey, idx, 'goal')),
      add("Kapus véd. +","ghost",()=> addEvent(teamKey, idx, 'save')),
      add("7m gól +","ghost",()=> addEvent(teamKey, idx, 'p7')),
      add("7m kih. +","ghost",()=> addEvent(teamKey, idx, 'p7m')),
      add("Gól –","",()=> removeEvent(teamKey, idx, 'goal')),
      add("Véd. –","",()=> removeEvent(teamKey, idx, 'save')),
      add("7m gól –","",()=> removeEvent(teamKey, idx, 'p7')),
      add("7m kih. –","",()=> removeEvent(teamKey, idx, 'p7m')),
    );
    act.appendChild(g); tr.appendChild(act);

    tr.addEventListener('click', ()=>{ lastFocus={team:teamKey, idx}; });
    body.appendChild(tr);
  });

  const t=teamTotals(team);
  const map = teamKey==='A'
    ? {H1G:'aH1G',H1S:'aH1S',H1P:'aH1P',H1PM:'aH1PM',H2G:'aH2G',H2S:'aH2S',H2P:'aH2P',H2PM:'aH2PM',shots:'aShots',goals:'aGoals',saves:'aSaves',p7pct:'a7mPct',pct:'aPct'}
    : {H1G:'bH1G',H1S:'bH1S',H1P:'bH1P',H1PM:'bH1PM',H2G:'bH2G',H2S:'bH2S',H2P:'bH2P',H2PM:'bH2PM',shots:'bShots',goals:'bGoals',saves:'bSaves',p7pct:'b7mPct',pct:'bPct'};
  $(map.H1G).textContent=t.H1G; $(map.H1S).textContent=t.H1S; $(map.H1P).textContent=t.H1P; $(map.H1PM).textContent=t.H1PM;
  $(map.H2G).textContent=t.H2G; $(map.H2S).textContent=t.H2S; $(map.H2P).textContent=t.H2P; $(map.H2PM).textContent=t.H2PM;
  $(map.shots).textContent=t.shots; $(map.goals).textContent=t.goals; $(map.saves).textContent=t.saves;
  $(map.p7pct).textContent=t.p7pct; $(map.pct).textContent=t.pct;

  const gk = team.gk;
  const gkShow = teamKey==='A' ? $('aGKshow') : $('bGKshow');
  const savePct = pct(gk.saves + gk.p7, gk.saves + gk.p7 + gk.goalsAgainst);
  gkShow.textContent = `Védés: ${gk.saves} • Kapott: ${gk.goalsAgainst} • 7m védés: ${gk.p7} • Védési%: ${savePct}`;

  updateScore();
}

function renderAll(){
  $('halfLabel').textContent = currentHalf===1? "1. félidő" : "2. félidő";
  $('matchName').value = app.match || "";
  $('teamAName').value = app.teamA.name || "";
  $('teamBName').value = app.teamB.name || "";
  if(app.teamA.logo) $('crestA').src = app.teamA.logo;
  if(app.teamB.logo) $('crestB').src = app.teamB.logo;
  renderTeam('A'); renderTeam('B');
}

function pushUndo(payload){ app.undo.push(JSON.stringify(payload)); app.redo.length=0; }
function addEvent(teamKey, idx, type){
  const team = teamKey==='A'?app.teamA:app.teamB;
  const p = team.players[idx]; const h = (currentHalf===1?p.h1:p.h2);
  pushUndo({teamKey, idx, before: JSON.parse(JSON.stringify(p))});
  if(type==='goal') h.g++;
  else if(type==='save') h.s++;
  else if(type==='p7') h.p++;
  else if(type==='p7m') h.pm++;
  saveLocal(true); renderTeam(teamKey);
}
function removeEvent(teamKey, idx, type){
  const team = teamKey==='A'?app.teamA:app.teamB;
  const p = team.players[idx]; const h = (currentHalf===1?p.h1:p.h2);
  pushUndo({teamKey, idx, before: JSON.parse(JSON.stringify(p))});
  if(type==='goal' && h.g>0) h.g--;
  if(type==='save' && h.s>0) h.s--;
  if(type==='p7' && h.p>0) h.p--;
  if(type==='p7m' && h.pm>0) h.pm--;
  saveLocal(true); renderTeam(teamKey);
}
function undo(){
  const u = app.undo.pop(); if(!u) return;
  const st = JSON.parse(u); const team = st.teamKey==='A'?app.teamA:app.teamB;
  const cur = team.players[st.idx];
  app.redo.push(JSON.stringify({teamKey:st.teamKey, idx:st.idx, before: JSON.parse(JSON.stringify(cur))}));
  team.players[st.idx]=st.before;
  saveLocal(true); renderTeam(st.teamKey);
}
function redo(){
  const r = app.redo.pop(); if(!r) return;
  const st = JSON.parse(r); const team = st.teamKey==='A'?app.teamA:app.teamB;
  const cur = team.players[st.idx];
  app.undo.push(JSON.stringify({teamKey:st.teamKey, idx:st.idx, before: JSON.parse(JSON.stringify(cur))}));
  team.players[st.idx]=st.before;
  saveLocal(true); renderTeam(st.teamKey);
}

let clockInterval=null;
function updateClock(){
  const m=Math.floor(app.remainingSeconds/60), s=app.remainingSeconds%60;
  $('clock').textContent = `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
}
function startClock(){ if(clockInterval) return;
  clockInterval=setInterval(()=>{
    app.remainingSeconds=Math.max(0,app.remainingSeconds-1);
    updateClock();
    if(app.remainingSeconds===0){ pauseClock(); alert((currentHalf===1?"1.":"2.")+" félidő lejárt."); }
  },1000);
}
function pauseClock(){ if(clockInterval){ clearInterval(clockInterval); clockInterval=null; } }
function resetClock(){ pauseClock(); app.remainingSeconds=30*60; updateClock(); }
function switchHalf(){ pauseClock(); currentHalf=(currentHalf===1?2:1); resetClock(); saveLocal(false); renderAll(); }

function saveLocal(_compute=true){
  app.match = $('matchName').value || "";
  app.teamA.name = $('teamAName').value || "";
  app.teamB.name = $('teamBName').value || "";
  localStorage.setItem('hb_dual_pro_v1', JSON.stringify(app));
  if(_compute) updateScore();
}
function loadLocal(){
  const raw=localStorage.getItem('hb_dual_pro_v1'); if(!raw) return;
  try{
    const obj=JSON.parse(raw);
    if(obj){ Object.assign(app, obj); }
  }catch(e){ console.warn(e); }
}
function exportCSV(){
  const mk=(team, side)=>{
    const header=["Csapat", "Sorszám","Név","H1 G","H1 Véd","H1 7mG","H1 7mK","H2 G","H2 Véd","H2 7mG","H2 7mK","Össz löv","Össz gól","Össz véd","7m%","Gól%"];
    const rows=team.players.map(p=>{
      const Tshots=shotsOf(p), Tgoals=goalsOf(p), Tsaves=savesOn(p), P7=p7Of(p);
      return [team.name||side, p.num, p.name, p.h1.g, p.h1.s, p.h1.p, p.h1.pm, p.h2.g, p.h2.s, p.h2.p, p.h2.pm,
              Tshots, Tgoals, Tsaves, pct(P7.g,P7.g+P7.m), pct(Tgoals,Tshots)];
    });
    return [header, ...rows];
  };
  const csv=[...mk(app.teamA,'A'),[],...mk(app.teamB,'B')].map(r=> Array.isArray(r)? r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(",") : "").join("\n");
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kezilabda_dual_pro.csv';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
}
function exportJSON(){
  const out = JSON.stringify(app, null, 2);
  const blob = new Blob([out], {type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kezilabda_dual_pro.json';
  document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
}
function importJSON(){
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=(e)=>{
    const f=e.target.files?.[0]; if(!f) return;
    const r=new FileReader(); r.onload=()=>{
      try{
        const data=JSON.parse(r.result);
        Object.assign(app, data);
        ensurePlayers(app.teamA); ensurePlayers(app.teamB);
        updateClock(); renderAll(); saveLocal(true);
      }catch{ alert('Hibás JSON fájl.'); }
    }; r.readAsText(f);
  };
  inp.click();
}

$('startBtn').addEventListener('click', startClock);
$('pauseBtn').addEventListener('click', pauseClock);
$('resetClockBtn').addEventListener('click', resetClock);
$('switchHalfBtn').addEventListener('click', switchHalf);
$('undoBtn').addEventListener('click', undo);
$('redoBtn').addEventListener('click', redo);
$('exportBtn').addEventListener('click', exportCSV);
$('saveBtn').addEventListener('click', exportJSON);
$('loadBtn').addEventListener('click', importJSON);
$('pdfBtn').addEventListener('click', ()=> window.print());
$('themeBtn').addEventListener('click', ()=>{
  const body=document.getElementById('body');
  body.classList.toggle('light');
});
$('clearBtn').addEventListener('click', ()=>{
  if(!confirm("Biztosan új meccset kezdesz? Minden adat törlődik.")) return;
  localStorage.removeItem('hb_dual_pro_v1');
  Object.assign(app,{ match:"", teamA:{name:"",logo:"",gk:{saves:0,goalsAgainst:0,p7:0},players:[]},
                           teamB:{name:"",logo:"",gk:{saves:0,goalsAgainst:0,p7:0},players:[]},
                           remainingSeconds:30*60, undo:[], redo:[] });
  ensurePlayers(app.teamA); ensurePlayers(app.teamB);
  currentHalf=1; updateClock(); renderAll(); saveLocal(true);
});
$('matchName').addEventListener('input', ()=> saveLocal(false));
$('teamAName').addEventListener('input', ()=> saveLocal(false));
$('teamBName').addEventListener('input', ()=> saveLocal(false));
$('fillA').addEventListener('click', ()=>{
  const t=app.teamA; if(t.players.some(p=>p.name||p.num)){ if(!confirm("Felülírjam A neveit/számait sablonnal?")) return; }
  t.players.forEach((p,i)=> Object.assign(p, defaultPlayer(), {num:String(i+1), name:"A Játékos "+(i+1)}));
  saveLocal(true); renderTeam('A');
});
$('fillB').addEventListener('click', ()=>{
  const t=app.teamB; if(t.players.some(p=>p.name||p.num)){ if(!confirm("Felülírjam B neveit/számait sablonnal?")) return; }
  t.players.forEach((p,i)=> Object.assign(p, defaultPlayer(), {num:String(i+1), name:"B Játékos "+(i+1)}));
  saveLocal(true); renderTeam('B');
});
$('logoAInput').addEventListener('change', (e)=> readLogo(e.target.files?.[0], 'A'));
$('logoBInput').addEventListener('change', (e)=> readLogo(e.target.files?.[0], 'B'));
function readLogo(file, key){
  if(!file) return; const r=new FileReader(); r.onload=()=>{
    if(key==='A'){ app.teamA.logo=r.result; $('crestA').src=r.result; }
    else { app.teamB.logo=r.result; $('crestB').src=r.result; }
    saveLocal(false);
  }; r.readAsDataURL(file);
}

$('aGKsave').addEventListener('click', ()=>{ app.teamA.gk.saves++; renderTeam('A'); saveLocal(false); });
$('aGKgoal').addEventListener('click', ()=>{ app.teamA.gk.goalsAgainst++; renderTeam('A'); saveLocal(false); });
$('aGKp7').addEventListener('click', ()=>{ app.teamA.gk.p7++; renderTeam('A'); saveLocal(false); });
$('aGKminusS').addEventListener('click', ()=>{ app.teamA.gk.saves=Math.max(0,app.teamA.gk.saves-1); renderTeam('A'); saveLocal(false); });
$('aGKminusG').addEventListener('click', ()=>{ app.teamA.gk.goalsAgainst=Math.max(0,app.teamA.gk.goalsAgainst-1); renderTeam('A'); saveLocal(false); });
$('aGKminusP').addEventListener('click', ()=>{ app.teamA.gk.p7=Math.max(0,app.teamA.gk.p7-1); renderTeam('A'); saveLocal(false); });

$('bGKsave').addEventListener('click', ()=>{ app.teamB.gk.saves++; renderTeam('B'); saveLocal(false); });
$('bGKgoal').addEventListener('click', ()=>{ app.teamB.gk.goalsAgainst++; renderTeam('B'); saveLocal(false); });
$('bGKp7').addEventListener('click', ()=>{ app.teamB.gk.p7++; renderTeam('B'); saveLocal(false); });
$('bGKminusS').addEventListener('click', ()=>{ app.teamB.gk.saves=Math.max(0,app.teamB.gk.saves-1); renderTeam('B'); saveLocal(false); });
$('bGKminusG').addEventListener('click', ()=>{ app.teamB.gk.goalsAgainst=Math.max(0,app.teamB.gk.goalsAgainst-1); renderTeam('B'); saveLocal(false); });
$('bGKminusP').addEventListener('click', ()=>{ app.teamB.gk.p7=Math.max(0,app.teamB.gk.p7-1); renderTeam('B'); saveLocal(false); });

document.addEventListener('keydown', (e)=>{
  if(e.target.tagName==='INPUT') return;
  if(e.code==='Space'){ e.preventDefault(); if(clockInterval) pauseClock(); else startClock(); }
  else if(e.key==='h' || e.key==='H'){ switchHalf(); }
  else if((e.ctrlKey||e.metaKey) && (e.key==='z' || e.key==='Z')){ e.preventDefault(); undo(); }
  else if((e.ctrlKey||e.metaKey) && (e.key==='y' || e.key==='Y')){ e.preventDefault(); redo(); }
});

function init(){
  loadLocal();
  ensurePlayers(app.teamA); ensurePlayers(app.teamB);
  updateClock();
  renderAll();
}
init();
</script>
</body>
</html>
